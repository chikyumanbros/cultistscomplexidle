<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cultist's Complex.idle</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Creepster&family=Press+Start+2P&family=Orbitron:wght@400;700&family=Audiowide&display=swap');


        :root {
            --bg-color: #0a0a0a;
            --text-color: #e0e0e0;
            --panel-bg: #1a1a1a;
            --highlight-color: #c31515;
            --button-color: #4CAF50;
            --button-hover: #45a049;
            --button-disabled: #9a1e1e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Webkit ブラウザ (Chrome, Safari, newer versions of Edge) 用 */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 6px;
            border: 3px solid #1a1a1a;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #45a049;
        }

        /* Firefox 用 (version 64 以降) */
        * {
            scrollbar-width: thin;
            scrollbar-color: #4CAF50 #1a1a1a;
        }

        body {
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            user-select: none;
        }

        /* 共通のボタンスタイル */
        button {
            font-size: 11px;
            padding: 4px 8px;
            background-color: transparent;
            color: #e0e0e0;
            border: 1px solid #4CAF50;
            border-radius: 3px;
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 2px 0;
        }

        button:hover {
            background-color: rgba(76, 175, 80, 0.2);
            color: #ffffff;
        }

        button:active {
            background-color: rgba(76, 175, 80, 0.4);
        }

        button:disabled {
            border-color: #555;
            color: #888;
            cursor: not-allowed;
        }

        button:disabled:hover {
            background-color: transparent;
        }

        @keyframes white-flash {
            0% {
                filter: brightness(100%);
            }

            50% {
                filter: brightness(200%);
            }

            100% {
                filter: brightness(100%);
            }
        }

        .white-flash {
            animation: white-flash 0.5s;
        }

        .red-filter {
            filter: sepia(100%) saturate(300%) brightness(70%) hue-rotate(300deg);
        }

        .floating-buttons-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .floating-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: block;
            font-size: 16px;
            margin: 4px 2px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
            transition: 0.3s;
        }

        .floating-button:hover {
            background-color: #45a049;
            box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2);
        }

        #backToTopBtn {
            display: none;
            /* 初期状態では非表示 */
        }

        #backToTopBtn:hover {
            background-color: #45a049;
        }

        /* フローティングボタンコンテナの下部にマージンを追加 */
        .floating-buttons-container {
            margin-bottom: 70px;
            /* Back to Topボタンの高さ + 余白 */
        }


        #ascii-title-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0 0 0;
            /* 下部のマージンを削除 */
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: 10px 10px 0 0;
            /* 上部の角だけを丸く */
        }

        #ascii-title {
            font-family: 'Courier New', monospace;
            line-height: 1.2;
            white-space: pre;
            text-align: center;
            color: #1aff1a;
            text-shadow: 0 0 5px #1aff1a, 0 0 10px #1aff1a;
            font-size: 12px;
            font-weight: bold;
            margin: 0;
            padding: 0;
        }

        #version-display {
            font-family: 'Courier New', monospace;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #1aff1a;
            text-shadow: 0 0 5px #1aff1a, 0 0 10px #1aff1a;
            margin-top: -15px;
            margin-bottom: 15px;
            background-color: var(--bg-color);
            /* 背景色を追加 */
            padding: 5px;
            border-radius: 0 0 10px 10px;
            /* 下部の角を丸く */
        }

        @media (max-width: 768px) {
            #ascii-title {
                font-size: 8px;
            }

            #version-display {
                font-size: 12px;
            }
        }


        .container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            grid-template-rows: auto auto auto 1fr;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .panel {
            background-color: var(--panel-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #debugControls button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 2px 2px;
            cursor: pointer;
            border-radius: 3px;
        }

        #debugControls span {
            font-size: 14px;
            margin-left: 10px;
        }

        h1 {
            grid-column: 1 / -1;
            grid-row: 1;
            text-align: center;
            color: #10d12a;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(16, 209, 42, 0.5);
        }

        #resourceDisplay {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 10px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 255, 0, 0.2);
            font-family: 'Audiowide', cursive;
            max-width: 1600px;
            /* 最大幅を設定 */
            margin: 0 auto;
            /* 中央揃え */
            width: 100%;
            /* 画面幅の90%に設定 */
            justify-content: space-between;
            /* space-aroundを削除 */
        }

        .resource-value-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-bottom: 5px;
        }

        .resource-value {
            display: inline-block;
            min-width: 80px;
            text-align: right;
        }

        .resource-rate {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            width: 120px;
            display: inline-block;
            text-align: right;
            color: #1aff1a;
        }

        .resource-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 40%;
            /* 追加 */
            text-align: center;
        }

        .resource-column h2 {
            /*font-size: 1.2em;  /* Press Start 2P の場合 */
            font-size: 1em;
            /* Orbitron または Audiowide の場合 */
            margin-bottom: 5px;
            color: #1aff1a;
            text-shadow: 0 0 5px #1aff1a, 0 0 10px #1aff1a;
        }

        #largeSourceCount,
        #largeMiasmaCount {
            /*font-size: 2em;  /* Press Start 2P の場合 */
            font-size: 2em;
            /* Orbitron または Audiowide の場合 */
            margin: 5px 0;
            color: #1aff1a;
            text-shadow: 0 0 5px #1aff1a, 0 0 10px #1aff1a;
        }

        #largeSourcePerSecond,
        #largeMiasmaPerSecond {
            /*font-size: 0.8em;  /* Press Start 2P の場合 */
            font-size: 1em;
            /* Orbitron または Audiowide の場合 */
            color: #1aff1a;
        }

        .ascii-emblem {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            line-height: 1;
            white-space: pre;
            text-align: center;
            margin: 0 20px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(26, 255, 26, 0.5);
        }

        .emblem-flash {
            animation: emblem-flash 1s ease-out;
        }

        @keyframes emblem-flash {
            0% {
                color: #FFFFFF;
                text-shadow: 0 0 10px #FFFFFF;
            }

            100% {
                color: inherit;
                text-shadow: none;
            }
        }

        .emblem-color1 {
            color: #1aff1a;
            text-shadow: 0 0 5px #1aff1a;
        }

        .emblem-color2 {
            color: #118011;
        }

        .emblem-color3 {
            color: #ff1a1a;
            text-shadow: 0 0 5px #ff1a1a;
        }

        .emblem-color4 {
            color: #ffff1a;
            text-shadow: 0 0 5px #ffff1a;
        }

        .sidebar {
            grid-column: 1 / 2;
            grid-row: 3 / 5;
        }

        .main-content {
            grid-column: 2 / 3;
            grid-row: 3 / 4;
        }

        .upgrades {
            grid-column: 3 / 4;
            grid-row: 3 / 5;
        }

        .madness-table {
            grid-column: 2 / 3;
            grid-row: 4 / 5;
        }

        button {
            background-color: var(--button-color);
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.3s;
        }

        button:hover:not(:disabled) {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }

        button:active:not(:disabled) {
            transform: translateY(1px);
        }

        button:disabled {
            background-color: var(--button-disabled);
            cursor: not-allowed;
            opacity: 0.7;
        }

        #monsterGridContainer {
            height: 700px;
            /* または望む高さ */
            overflow-y: auto;
            padding-right: 10px;
            /* スクロールバーのためのスペース */
        }

        .monster-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .monster-card {
            position: relative;
            background-color: #192320;
            padding: 15px;
            border-radius: 8px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .monster-card-header {
            position: relative;
        }

        .monster-card-header .tooltip {
            display: none;
            visibility: hidden;
            width: 300px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
            font-size: 14px;
        }

        #toggleAllMonsterCards {
            margin-bottom: 10px;
            /* 必要に応じて他のスタイルを追加 */
        }

        .monster-card-header:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .monster-card-header .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .monster-card-details {
            display: none;
            margin-top: 10px;
        }

        .monster-card-details.expanded {
            display: block;
        }


        .monster-card .summon-progress-bar {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            width: 120px;
            height: 12px;
            background-color: #222;
            /* より暗い背景色 */
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #4CAF50;
        }

        .monster-card .resource-progress {
            height: 50%;
            position: absolute;
            left: 0;
            transition: width 0.3s ease;
        }

        .monster-card .source-progress {
            top: 0;
            background: linear-gradient(90deg,
                    #4eff54 0%,
                    /* より明るい緑 */
                    #45ff4c 100%
                    /* より明るい緑 */
                );
            box-shadow: 0 0 5px #4CAF50;
            /* グロー効果を追加 */
        }

        .monster-card .follower-progress {
            bottom: 0;
            background: linear-gradient(90deg,
                    #ff47ff 0%,
                    /* より明るいパープル */
                    #ff00ff 100%
                    /* より明るいパープル */
                );
            box-shadow: 0 0 5px #ff00ff;
            /* グロー効果を追加 */
        }

        /* 不透明度も調整 */
        .monster-card .source-progress,
        .monster-card .follower-progress {
            opacity: 0.8 !important;
            /* 完了状態 */
        }

        .monster-card .source-progress[style*="width: 0"],
        .monster-card .follower-progress[style*="width: 0"] {
            opacity: 0.6 !important;
            /* 未完了状態 */
        }

        .summon-monster-btn {
            transition: background-color 0.3s, opacity 0.3s;
        }

        .toggle-details {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.5em;
        }

        #adventurers {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .adventurer {
            flex: 0 1 calc(33.333% - 20px);
            margin: 10px;
            text-align: center;
        }

        .madness-btn {
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
            min-width: 120px;
            /* 最小幅を設定 */
            height: 36px;
            /* 高さを固定 */
            line-height: 36px;
            /* テキストを垂直中央揃え */
            padding: 0 10px;
            /* 左右のパディングを追加 */
            white-space: nowrap;
            /* テキストを1行に */
            overflow: hidden;
            /* はみ出した部分を隠す */
            text-overflow: ellipsis;
            /* はみ出した部分を...で表示 */
        }

        .madness-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .upgrade-symbol {
            position: relative;
            cursor: help;
        }

        .upgrade-symbol .tooltip {
            font-family: 'Roboto', sans-serif;
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .upgrade-symbol:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }


        #log {
            height: 150px;
            overflow-y: auto;
            background-color: #222;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-top: 20px;
        }

        #log p {
            margin: 5px 0;
            padding: 5px;
            background-color: #2a2a2a;
            border-radius: 3px;
        }


        .ascii-art {
            font-family: 'Courier New', monospace;
            line-height: 1;
            white-space: pre;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            margin: 0;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto auto 1fr;
            }

            .sidebar,
            .upgrades {
                grid-column: auto;
                grid-row: auto;
            }

            .main-content,
            .madness-table {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto auto auto;
            }

            .sidebar,
            .main-content,
            .upgrades,
            .madness-table {
                grid-column: 1 / -1;
                grid-row: auto;
            }
        }

        #game-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--bg-color);
            padding: 5px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #top-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            padding: 5px;
            flex-wrap: wrap;
            background-color: var(--bg-color);
        }

        #top-buttons button {
            font-size: 11px;
            padding: 4px 8px;
            background-color: transparent;
            color: #e0e0e0;
            border: 1px solid #4CAF50;
            border-radius: 3px;
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 2px 0;
            /* すべてのボタンに上下のマージンを追加 */
        }

        #top-buttons button:hover {
            background-color: rgba(76, 175, 80, 0.2);
            color: #ffffff;
        }

        #top-buttons button:active {
            background-color: rgba(76, 175, 80, 0.4);
        }

        #top-buttons button#resetButton {
            border-color: #ff0000;
            color: #ff0000;
        }

        #top-buttons button#resetButton:hover {
            background-color: rgba(255, 0, 0, 0.2);
            color: #ffffff;
        }

        #top-buttons button#resetButton:active {
            background-color: rgba(255, 0, 0, 0.4);
        }

        /* 折りたたみボタンのスタイルを他のボタンと揃える */
        #toggleAllMonsterCards {
            margin: 2px 0;
        }

        #resourceDisplay {
            position: relative;
            top: 0;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 10px;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .container {
            margin-top: 20px;
            /* Adjust as needed */
        }

        .modal-overlay {
            display: none;
            /* 明示的に非表示に設定 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            display: block !important;
            /* モーダルを確実に表示 */
        }

        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: #e0e0e0;
            border: 1px solid #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translate(-50%, -50%) scale(1);
        }

        /* ScrollBar Styling */
        .modal-content::-webkit-scrollbar {
            width: 10px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 5px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 5px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #45a049;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4CAF50;
            position: sticky;
            top: 0;
            background-color: #1a1a1a;
            z-index: 1;
        }

        .modal-title {
            font-size: 1.5em;
            color: #4CAF50;
            margin: 0;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .close-button {
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            margin: -5px -10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .close-button:hover {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 10px;
        }

        .stats-section {
            background-color: #222;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stats-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .stats-section h3 {
            color: #4CAF50;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .stat-label {
            color: #aaa;
        }

        .stat-value {
            color: #fff;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        /* ボタンのアクティブ状態のスタイル */
        #statisticsButton.active {
            background-color: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }
    </style>
</head>

<body>

    <div id="debugControls" style="position: fixed; top: 10px; left: 10px; z-index: 1000;"></div>
    <button id="toggleTimeAcceleration">Toggle Time Acceleration</button>
    <span id="timeAccelerationDisplay">x1</span>
    </div>
    <div id="ascii-title-container">
        <pre id="ascii-title">
██████╗██╗   ██╗██╗  ████████╗██╗███████╗████████╗███████╗
██╔════╝██║   ██║██║  ╚══██╔══╝██║██╔════╝╚══██╔══╝██╔════╝
██║     ██║   ██║██║     ██║   ██║███████╗   ██║   ███████╗
██║     ██║   ██║██║     ██║   ██║╚════██║   ██║   ╚════██║
╚██████╗╚██████╔╝███████╗██║   ██║███████║   ██║   ███████║
    ╚═════╝ ╚═════╝ ╚══════╝╚═╝   ╚═╝╚══════╝   ╚═╝   ╚══════╝
██████╗ ██████╗ ███╗   ███╗██████╗ ██╗     ███████╗██╗  ██╗
██╔════╝██╔═══██╗████╗ ████║██╔══██╗██║     ██╔════╝╚██╗██╔╝
██║     ██║   ██║██╔████╔██║██████╔╝██║     █████╗   ╚███╔╝ 
██║     ██║   ██║██║╚██╔╝██║██╔═══╝ ██║     ██╔══╝   ██╔██╗ 
╚██████╗╚██████╔╝██║ ╚═╝ ██║██║     ███████╗███████╗██╔╝ ██╗
    ╚═════╝ ╚═════╝ ╚═╝     ╚═╝╚═╝     ╚══════╝╚══════╝╚═╝  ╚═╝
░▒▓██╗██████╗ ██╗     ███████╗█▓▒░
░▒▓█╔╝██╔══██╗██║     ██╔════╝█▓▒░
░▒▓█║ ██║  ██║██║     █████╗  █▓▒░
░▒▓█║ ██║  ██║██║     ██╔══╝  █▓▒░
░▒▓╚██╗██████╔╝███████╗███████╗▓▒░
░▒▓ ╚═╝╚═════╝ ╚══════╝╚══════╝▓▒░
☽ ♆ ♄ Summon. Corrupt. Conquer. Idle. ♃ ♇ ☾
    </pre>
    </div>
    <div id="version-display">v0.1.1</div>
    <div id="statisticsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Game Statistics</h2>
                <button class="close-button" onclick="closeStatisticsModal()">×</button>
            </div>
            <div class="stats-grid">
                <div class="stats-section">
                    <h3>General Statistics</h3>
                    <div class="stat-item">
                        <span class="stat-label">Time Played:</span>
                        <span class="stat-value" id="timePlayed">0s</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Source Generated:</span>
                        <span class="stat-value" id="totalSourceGenerated">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Miasma Generated:</span>
                        <span class="stat-value" id="totalMiasmaGenerated">0</span>
                    </div>
                </div>
                <div class="stats-section">
                    <h3>Follower Statistics</h3>
                    <div class="stat-item">
                        <span class="stat-label">Total Followers Recruited:</span>
                        <span class="stat-value" id="totalFollowersRecruited">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Peak Followers:</span>
                        <span class="stat-value" id="peakFollowers">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Current Efficiency:</span>
                        <span class="stat-value" id="currentFollowerEfficiency">0</span>
                    </div>
                </div>
                <div class="stats-section">
                    <h3>Monster Statistics</h3>
                    <div class="stat-item">
                        <span class="stat-label">Total Monsters Summoned:</span>
                        <span class="stat-value" id="totalMonstersSummoned">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Unique Monster Types:</span>
                        <span class="stat-value" id="uniqueMonsterTypes">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Most Common Monster:</span>
                        <span class="stat-value" id="mostCommonMonster">None</span>
                    </div>
                </div>
                <div class="stats-section">
                    <h3>Madness Statistics</h3>
                    <div class="stat-item">
                        <span class="stat-label">Total Madness Attempts:</span>
                        <span class="stat-value" id="totalMadnessAttempts">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Successful Madness:</span>
                        <span class="stat-value" id="successfulMadness">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Madness Success Rate:</span>
                        <span class="stat-value" id="madnessSuccessRate">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="game-header">
        <div id="top-buttons">
            <button id="toggleAllMonsterCards">Toggle All Cards</button>
            <button id="jumpToSummonOldOne">Jump to Summon Old One</button>
            <button id="jumpToMadnessTable">Jump to Madness Table</button>
            <button id="backToTopBtn">Back to Top</button>
            <button onclick="saveGame()">Save Game</button>
            <button onclick="loadGame()">Load Game</button>
            <button id="resetButton" onclick="resetGameAndClearSave()">Reset Game</button>
        </div>
        <div id="resourceDisplay" class="panel">
            <div class="resource-column">
                <h2>Source Collected</h2>
                <div class="resource-value-container">
                    <p id="largeSourceCount" class="resource-value">0</p>
                </div>
                <span id="upgradeSymbols"></span>
                <p>(+<span id="largeSourcePerSecond">0</span>/sec)</p>
            </div>
            <div id="emblem" class="ascii-emblem"></div>
            <div class="resource-column">
                <h2>Miasma Accumulated</h2>
                <div class="resource-value-container">
                    <p id="largeMiasmaCount" class="resource-value">0</p>
                </div>
                <p>(+<span id="largeMiasmaPerSecond">0</span>/sec)</p>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="sidebar panel">
            <div id="followerSection">
                <h2>Followers</h2>
                <div class="ascii-art" id="followerAsciiArt">
                    ${asciiArt['Follower']}
                </div>
                <p>Count: <span id="followerCount">0</span></p>
                <p>Efficiency: <span id="followerEfficiency">0.1</span></p>
                <p>Production: <span id="followerPerSecond">0</span>/sec</p>
                <p>Next Recruit Cost: <span id="nextFollowerCost">10</span> source</p>
            </div>
            <h2>Resources</h2>
            <button onclick="collectSource()">Collect Source</button>
            <button id="recruitFollowerBtn">Recruit Follower</button>

            <div id="gameDetails">
                <h2>Game Details</h2>
                <p><strong>Follower Efficiency:</strong> <span id="followerEfficiencyDetail">0.1</span></p>
                <p><strong>Follower Boost:</strong> <span id="followerBoost">1.00</span>x</p>
                <p><strong>Monster Synergy Boost:</strong> <span id="monsterSynergyBoost">1.00</span>x</p>
                <p><strong>Active Upgrades:</strong> <span id="activeUpgrades">None</span></p>
                <h3>Monster Production:</h3>
                <div id="monsterProductionDetails">
                    <!-- Monster production details will be dynamically added here -->
                </div>
            </div>

            <div id="log">
                <h2>Actions Log</h2>
                <div id="logEntries">
                    <!-- Log entries will be dynamically added here -->
                </div>
            </div>
        </div>

        <div class="main-content panel">
            <h2>Summon Old Ones</h2>
            <div id="monsterGridContainer">
                <div id="monsterGrid" class="monster-grid">

                </div>
            </div>
        </div>


        <div class="upgrades panel">
            <h2>Upgrades</h2>
            <div id="upgradeGrid" class="upgrade-grid">

                <!-- Additional upgrade cards will be dynamically added here -->
            </div>
        </div>

        <div class="madness-table panel" id="madnessTable">
            <h2>Madness Table</h2>
            <div id="adventurers">
            </div>
        </div>

        <script>
            const gameVersion = '0.1.1';

            // グローバルロックとアクション固有のロックを追加
            let globalLock = false;
            const actionLocks = {
                recruitFollower: false,
                summonMonster: {}
            };

            let timeAcceleration = 1; // デフォルトは通常速度
            // Game state
            let gameState = {

                source: 0,
                miasma: 0,
                followers: 0,
                monsters: {
                    'Shoggoth': {
                        count: 0,
                        sourceEfficiency: 0.5,
                        miasmaEfficiency: 0.1,
                        baseFollowerCost: 1,
                        followerCostGrowth: 1.1,
                        synergy: { partner: 'Deep One', effect: 0.09 },
                        specialAbility: { trigger: 100, effect: { type: 'allMonsterEfficiency', value: 0.005 } }
                    },
                    'This Man': {
                        count: 0,
                        sourceEfficiency: 1.8,
                        miasmaEfficiency: 0.36,
                        baseFollowerCost: 2,
                        followerCostGrowth: 1.12,
                        synergy: { partner: 'Byakhee', effect: 0.135, type: 'miasma' },
                        specialAbility: { trigger: 50, effect: { type: 'followerEfficiencyMultiplier', value: 0.009 } }
                    },
                    'Deep One': {
                        count: 0,
                        sourceEfficiency: 3.0,
                        miasmaEfficiency: 0.5,
                        baseFollowerCost: 3,
                        followerCostGrowth: 1.15,
                        synergy: { partner: 'Shoggoth', effect: 0.09 },
                        specialAbility: {
                            trigger: 25,
                            effect: {
                                type: 'miasmaEfficiency',
                                value: 0.045
                            }
                        }
                    },
                    'Byakhee': {
                        count: 0,
                        sourceEfficiency: 6.5,
                        miasmaEfficiency: 1.1,
                        baseFollowerCost: 4,
                        followerCostGrowth: 1.17,
                        synergy: { partner: 'This Man', effect: 0.135, type: 'miasma' },
                        specialAbility: { trigger: 30, effect: { type: 'sourceProduction', value: 0.027 } }
                    },
                    'Elder Thing': {
                        count: 0,
                        sourceEfficiency: 10.0,
                        miasmaEfficiency: 2.0,
                        baseFollowerCost: 5,
                        followerCostGrowth: 1.2,
                        synergy: { partner: 'Mi-go', effect: 0.18, type: 'source' },
                        specialAbility: { trigger: 20, effect: { type: 'upgradeEffect', value: 0.009 } }
                    },
                    'Mossman': {
                        count: 0,
                        sourceEfficiency: 16.0,
                        miasmaEfficiency: 3.2,
                        baseFollowerCost: 7,
                        followerCostGrowth: 1.22,
                        synergy: { partner: 'Nightgaunt', effect: 0.225, type: 'miasma' },
                        specialAbility: { trigger: 15, effect: { type: 'followerProduction', value: 0.09 } }
                    },
                    'Star Spawn': {
                        count: 0,
                        sourceEfficiency: 25.0,
                        miasmaEfficiency: 5.0,
                        baseFollowerCost: 10,
                        followerCostGrowth: 1.25,
                        synergy: { partner: 'Uroboros', effect: 0.27 },
                        specialAbility: { trigger: 10, effect: { type: 'cosmicResonance', value: 0.01 } }
                    },
                    'Mi-go': {
                        count: 0,
                        sourceEfficiency: 75.0,
                        miasmaEfficiency: 15.0,
                        baseFollowerCost: 20,
                        followerCostGrowth: 1.3,
                        synergy: { partner: 'Elder Thing', effect: 0.18, type: 'source' },
                        specialAbility: {
                            trigger: 5,
                            effect: {
                                type: 'upgradeCost',
                                value: 0.0025,
                                maxDiscount: 0.4
                            }
                        }
                    },
                    'Nightgaunt': {
                        count: 0,
                        sourceEfficiency: 250.0,
                        miasmaEfficiency: 50.0,
                        baseFollowerCost: 50,
                        followerCostGrowth: 1.35,
                        synergy: {
                            partner: 'Mossman',
                            effect: 0.225,
                            type: 'miasma'
                        },
                        specialAbility: {
                            trigger: 3,
                            effect: {
                                type: 'adventurerResistanceRecoveryTime',
                                value: 1000  // 1秒（1000ミリ秒）のクールダウン削減
                            }
                        }
                    },
                    'Uroboros': {
                        count: 0,
                        sourceEfficiency: 900.0,
                        miasmaEfficiency: 180.0,
                        baseFollowerCost: 100,
                        followerCostGrowth: 1.4,
                        synergy: { partner: 'Star Spawn', effect: 0.27 },
                        specialAbility: { trigger: 1, effect: { type: 'allMonsterEfficiency', value: 0.0009 } }
                    }
                },
                upgrades: [],
                followerEfficiency: 0.1,
                adventurers: [
                    { name: "Novice Explorer", miasmaRequired: 100, followerReward: 1, followerProduction: 0.1, madnessChance: 0.55, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 33000 },
                    { name: "Seasoned Investigator", miasmaRequired: 500, followerReward: 4, followerProduction: 0.5, madnessChance: 0.35, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 66000 },
                    { name: "Arcane Scholar", miasmaRequired: 2000, followerReward: 18, followerProduction: 2.0, madnessChance: 0.18, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 132000 },
                    { name: "Occult Detective", miasmaRequired: 5000, followerReward: 45, followerProduction: 5.0, madnessChance: 0.13, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 198000 },
                    { name: "Eldritch Archaeologist", miasmaRequired: 10000, followerReward: 90, followerProduction: 10.0, madnessChance: 0.09, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 330000 },
                    { name: "Cosmic Voyager", miasmaRequired: 20000, followerReward: 180, followerProduction: 20.0, madnessChance: 0.045, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 660000 }
                ]
            };

            const initialGameState = {
                source: 0,
                miasma: 0,
                followers: 0,
                monsters: {
                    'Shoggoth': {
                        count: 0,
                        sourceEfficiency: 0.5,
                        miasmaEfficiency: 0.1,
                        baseFollowerCost: 1,
                        followerCostGrowth: 1.1,
                        synergy: { partner: 'Deep One', effect: 0.09 },
                        specialAbility: { trigger: 100, effect: { type: 'allMonsterEfficiency', value: 0.005 } }
                    },
                    'This Man': {
                        count: 0,
                        sourceEfficiency: 1.8,
                        miasmaEfficiency: 0.36,
                        baseFollowerCost: 2,
                        followerCostGrowth: 1.12,
                        synergy: { partner: 'Byakhee', effect: 0.135, type: 'miasma' },
                        specialAbility: { trigger: 50, effect: { type: 'followerEfficiencyMultiplier', value: 0.009 } }
                    },
                    'Deep One': {
                        count: 0,
                        sourceEfficiency: 3.0,
                        miasmaEfficiency: 0.5,
                        baseFollowerCost: 3,
                        followerCostGrowth: 1.15,
                        synergy: { partner: 'Shoggoth', effect: 0.09 },
                        specialAbility: {
                            trigger: 25,
                            effect: {
                                type: 'miasmaEfficiency',
                                value: 0.045
                            }
                        }
                    },
                    'Byakhee': {
                        count: 0,
                        sourceEfficiency: 6.5,
                        miasmaEfficiency: 1.1,
                        baseFollowerCost: 4,
                        followerCostGrowth: 1.17,
                        synergy: { partner: 'This Man', effect: 0.135, type: 'miasma' },
                        specialAbility: { trigger: 30, effect: { type: 'sourceProduction', value: 0.027 } }
                    },
                    'Elder Thing': {
                        count: 0,
                        sourceEfficiency: 10.0,
                        miasmaEfficiency: 2.0,
                        baseFollowerCost: 5,
                        followerCostGrowth: 1.2,
                        synergy: { partner: 'Mi-go', effect: 0.18, type: 'source' },
                        specialAbility: { trigger: 20, effect: { type: 'upgradeEffect', value: 0.009 } }
                    },
                    'Mossman': {
                        count: 0,
                        sourceEfficiency: 16.0,
                        miasmaEfficiency: 3.2,
                        baseFollowerCost: 7,
                        followerCostGrowth: 1.22,
                        synergy: { partner: 'Nightgaunt', effect: 0.225, type: 'miasma' },
                        specialAbility: { trigger: 15, effect: { type: 'followerProduction', value: 0.09 } }
                    },
                    'Star Spawn': {
                        count: 0,
                        sourceEfficiency: 25.0,
                        miasmaEfficiency: 5.0,
                        baseFollowerCost: 10,
                        followerCostGrowth: 1.25,
                        synergy: { partner: 'Uroboros', effect: 0.27 },
                        specialAbility: { trigger: 10, effect: { type: 'cosmicResonance', value: 0.01 } }
                    },
                    'Mi-go': {
                        count: 0,
                        sourceEfficiency: 75.0,
                        miasmaEfficiency: 15.0,
                        baseFollowerCost: 20,
                        followerCostGrowth: 1.3,
                        synergy: { partner: 'Elder Thing', effect: 0.18, type: 'source' },
                        specialAbility: {
                            trigger: 5,
                            effect: {
                                type: 'upgradeCost',
                                value: 0.0025,
                                maxDiscount: 0.4
                            }
                        }
                    },
                    'Nightgaunt': {
                        count: 0,
                        sourceEfficiency: 250.0,
                        miasmaEfficiency: 50.0,
                        baseFollowerCost: 50,
                        followerCostGrowth: 1.35,
                        synergy: {
                            partner: 'Mossman',
                            effect: 0.225,
                            type: 'miasma'
                        },
                        specialAbility: {
                            trigger: 3,
                            effect: {
                                type: 'adventurerResistanceRecoveryTime',
                                value: 1000  // 1秒（1000ミリ秒）のクールダウン削減
                            }
                        }
                    },
                    'Uroboros': {
                        count: 0,
                        sourceEfficiency: 900.0,
                        miasmaEfficiency: 180.0,
                        baseFollowerCost: 100,
                        followerCostGrowth: 1.4,
                        synergy: { partner: 'Star Spawn', effect: 0.27 },
                        specialAbility: { trigger: 1, effect: { type: 'allMonsterEfficiency', value: 0.0009 } }
                    }
                },
                upgrades: [],
                followerEfficiency: 0.1,

                cosmicAlignmentBonus: 1,
                astralProjectionRate: 0,
                quantumEntanglementBonus: 0,
                temporalManipulationBonus: 1,
                eldritchEvolutionRate: 0,
                upgradeCostMultiplier: 1,

                adventurers: [
                    { name: "Novice Explorer", miasmaRequired: 100, followerReward: 1, followerProduction: 0.1, madnessChance: 0.55, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 33000 },
                    { name: "Seasoned Investigator", miasmaRequired: 500, followerReward: 4, followerProduction: 0.5, madnessChance: 0.35, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 66000 },
                    { name: "Arcane Scholar", miasmaRequired: 2000, followerReward: 18, followerProduction: 2.0, madnessChance: 0.18, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 132000 },
                    { name: "Occult Detective", miasmaRequired: 5000, followerReward: 45, followerProduction: 5.0, madnessChance: 0.13, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 198000 },
                    { name: "Eldritch Archaeologist", miasmaRequired: 10000, followerReward: 90, followerProduction: 10.0, madnessChance: 0.09, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 330000 },
                    { name: "Cosmic Voyager", miasmaRequired: 20000, followerReward: 180, followerProduction: 20.0, madnessChance: 0.045, level: 0, isMad: false, cooldownEndTime: 0, baseCooldown: 660000 }
                ]
            };

            const monsterOrder = [
                'Shoggoth',
                'This Man',
                'Deep One',
                'Byakhee',
                'Elder Thing',
                'Mossman',
                'Star Spawn',
                'Mi-go',
                'Nightgaunt',
                'Uroboros'
            ];

            const baseCosts = {
                follower: 10,
                'Shoggoth': 100,
                'This Man': 250,
                'Deep One': 500,
                'Byakhee': 1000,
                'Elder Thing': 2500,
                'Mossman': 5000,
                'Star Spawn': 10000,
                'Mi-go': 50000,
                'Nightgaunt': 250000,
                'Uroboros': 1000000,
                'Ritual Knowledge': 100,
                'Eldritch Tome': 500,
                'Cosmic Alignment': 2.5e3,
                'Dark Pact': 1e4,
                "Hermes Trismegistus' Teachings": 5e4,
                'Cosmic Insight': 2.5e5,
                'Astral Projection': 1e6,
                'Necronomicon Fragment': 5e6,
                'Psychic Attunement': 2.5e7,
                'Quantum Entanglement': 1e8,
                'Temporal Manipulation': 5e8,
                'Eldritch Evolution': 2.5e9,
                'Dimensional Rift': 1e10
            };


            const upgradeEffects = {
                'Ritual Knowledge': 'Increases follower efficiency by 25%',
                'Eldritch Tome': 'Increases all monster efficiencies by 25%',
                'Cosmic Alignment': 'Improves overall production by 10% when followers and monsters are balanced',
                'Dark Pact': 'Increases source production by 40%',
                "Hermes Trismegistus' Teachings": 'Increases follower efficiency by 30%',
                'Cosmic Insight': 'Increases follower and monster efficiencies by 35%',
                'Astral Projection': 'Adds 3% of your total source to production every second',
                'Necronomicon Fragment': 'Boosts monster production by 50%',
                'Psychic Attunement': 'Increases miasma production by 30%',
                'Quantum Entanglement': 'Each monster type boosts the efficiency of another by 5%',
                'Temporal Manipulation': 'Speeds up resource generation by 20%',
                'Eldritch Evolution': 'Monsters gain 1% efficiency for every 10 levels',
                'Dimensional Rift': 'Increases the effect of all other upgrades by 50%'
            };

            const upgradeSymbols = {
                'Ritual Knowledge': '📚',
                'Eldritch Tome': '📜',
                'Cosmic Alignment': '🌌',
                'Dark Pact': '🔮',
                "Hermes Trismegistus' Teachings": '🌿',
                'Cosmic Insight': '👁️',
                'Astral Projection': '🪐',
                'Necronomicon Fragment': '📖',
                'Psychic Attunement': '🧠',
                'Quantum Entanglement': '🔗',
                'Temporal Manipulation': '⏳',
                'Eldritch Evolution': '🧬',
                'Dimensional Rift': '🕳️'
            };

            const asciiArt = {
                'Follower': `
<span style="color:#2E1A47">      ▄▄█▀▀█▄▄      </span>
<span style="color:#2E1A47">    ▄█▀</span><span style="color:#3D2A56">░░░░░░</span><span style="color:#2E1A47">▀█▄    </span>
<span style="color:#2E1A47">   █▀░</span><span style="color:#4B0082">▄▄███▄▄</span><span style="color:#2E1A47">░▀█   </span>
<span style="color:#2E1A47">  █░</span><span style="color:#4B0082">█</span><span style="color:#2E1A47">▒</span><span style="color:#1E1E1E">░░░░</span><span style="color:#2E1A47">▒</span><span style="color:#4B0082">█</span><span style="color:#2E1A47">░█  </span>
<span style="color:#2E1A47"> █░</span><span style="color:#4B0082">█▀▄</span><span style="color:#2E1A47">▒</span><span style="color:#1E1E1E">░░░</span><span style="color:#2E1A47">▒</span><span style="color:#4B0082">▄▀█</span><span style="color:#2E1A47">░█ </span>
<span style="color:#2E1A47">█░</span><span style="color:#4B0082">▄█▀░</span><span style="color:#2E1A47">▒</span><span style="color:#1E1E1E">░░░</span><span style="color:#2E1A47">▒</span><span style="color:#4B0082">░▀█▄</span><span style="color:#2E1A47">░█</span>
<span style="color:#2E1A47">█░</span><span style="color:#4B0082">█▄▄██████▄▄█</span><span style="color:#2E1A47">░█</span>
<span style="color:#2E1A47">█░</span><span style="color:#4B0082">███████████</span><span style="color:#2E1A47">░█</span>
<span style="color:#2E1A47">█░</span><span style="color:#6A0DAD">███</span><span style="color:#D2691E">▒▒▒▒▒</span><span style="color:#6A0DAD">███</span><span style="color:#2E1A47">░█</span>
<span style="color:#2E1A47">█░░</span><span style="color:#6A0DAD">██</span><span style="color:#D2691E">▒</span><span style="color:#FF1493">(@)</span><span style="color:#D2691E">▒</span><span style="color:#FF1493">(@)</span><span style="color:#D2691E">▒</span><span style="color:#6A0DAD">██</span><span style="color:#2E1A47">░░█</span>
<span style="color:#2E1A47">█▄░░</span><span style="color:#6A0DAD">█</span><span style="color:#D2691E">▒▒▒▒▒▒▒</span><span style="color:#6A0DAD">█</span><span style="color:#2E1A47">░░▄█</span>
<span style="color:#2E1A47"> █▀▄▄░</span><span style="color:#D2691E">▒▒▒▒▒</span><span style="color:#2E1A47">░▄▄▀█ </span>
<span style="color:#2E1A47"> ▀█░░▀</span><span style="color:#D2691E">▒▒▒▒▒</span><span style="color:#2E1A47">▀░░█▀ </span>
<span style="color:#2E1A47">  ▀█▄░░</span><span style="color:#D2691E">▒▒▒</span><span style="color:#2E1A47">░░▄█▀  </span>
<span style="color:#2E1A47">    ▀▀█▄▄▄█▀▀    </span>
    `,
                'Shoggoth': `
<span style="color:#004000">▄▄▄──────▄▄▄</span>
    <span style="color:#004000">▄██▀░</span><span style="color:#006000">▒▒▒</span><span style="color:#004000">░░░</span><span style="color:#006000">▒▒▒</span><span style="color:#004000">░▀██▄</span>
  <span style="color:#004000">██▀░</span><span style="color:#006000">▒</span><span style="color:#008000">▄▄</span><span style="color:#006000">▒▒▒▒▒▒▒▒</span><span style="color:#008000">▄▄</span><span style="color:#006000">▒</span><span style="color:#004000">░▀██</span>
 <span style="color:#004000">█▀░</span><span style="color:#006000">▒</span><span style="color:#00A000">▄█▀▀█ <span style="color:#FF0000"> + </span>  █▀▀█▄</span><span style="color:#006000">▒</span><span style="color:#004000">░▀█</span>
<span style="color:#004000">█▀░</span><span style="color:#006000">▒</span><span style="color:#00C000">▄█▀</span><span style="color:#FF0000"> + </span><span style="color:#00C000">░░</span><span style="color:#FF0000"> + </span><span style="color:#00C000">▀█▄</span><span style="color:#006000">▒</span><span style="color:#004000">░▀█</span>
<span style="color:#004000">█░</span><span style="color:#006000">▒</span><span style="color:#00E000">█▀</span><span style="color:#FF0000"> + </span><span style="color:#00E000">░░░░░░</span><span style="color:#FF0000"> ÷ </span><span style="color:#00E000">▀█</span><span style="color:#006000">▒</span><span style="color:#004000">░█</span>
<span style="color:#004000">█░</span><span style="color:#006000">▒</span><span style="color:#00FF00">█░▄▀▀</span><span style="color:#FF0000">\\--/</span><span style="color:#00FF00">▀▀▄░░█</span><span style="color:#006000">▒</span><span style="color:#004000">░█</span>
<span style="color:#004000">█░</span><span style="color:#006000">▒</span><span style="color:#00E000">█░█░░</span><span style="color:#FF0000">_\\/_</span><span style="color:#00E000">░░█░█</span><span style="color:#006000">▒</span><span style="color:#004000">░█</span>
<span style="color:#004000">█░</span><span style="color:#006000">▒</span><span style="color:#00C000">▀█▄▀</span><span style="color:#FF0000">/,\\,\\</span><span style="color:#00C000">▀▄█▀</span><span style="color:#006000">▒</span><span style="color:#004000">░█</span>
<span style="color:#004000">█▄░</span><span style="color:#006000">▒▒</span><span style="color:#00A000">▀▄</span><span style="color:#FF0000">'-'</span><span style="color:#00A000">▄▀</span><span style="color:#006000">▒▒</span><span style="color:#004000">░▄█</span>
 <span style="color:#004000">██▄░░</span><span style="color:#006000">▒▒▒▒▒▒</span><span style="color:#004000">░░▄██</span>
  <span style="color:#004000">▀██▄▄░░░░░░▄▄██▀</span>
    <span style="color:#004000">▀▀████████▀▀</span>
  <span style="color:#004000">▄█▀</span><span style="color:#006000">▒</span><span style="color:#00A000">█▒▒▒▒▒▒▒▒█</span><span style="color:#006000">▒</span><span style="color:#004000">▀█▄</span>
 <span style="color:#004000">█▀</span><span style="color:#006000">▒</span><span style="color:#00C000">█▒█▒▒▒▒▒▒█▒█</span><span style="color:#006000">▒</span><span style="color:#004000">▀█</span>
<span style="color:#004000">█</span><span style="color:#00FF00">▄█▒█▒█▒█▒█▒█▒█▒█▄</span><span style="color:#004000">█</span>
<span style="color:#004000">▀█▄</span><span style="color:#00E000">█▒█▒▒█▒█▒▒█▒█</span><span style="color:#004000">▄█▀</span>
    `,

                'This Man': `
<span style="color:#FFFFFF">       ▄███████████████▄       </span>
<span style="color:#FFFFFF">     ▄█▀</span><span style="color:#F0F0F0">░░░░░░░░░░░</span><span style="color:#FFFFFF">▀█▄     </span>
<span style="color:#FFFFFF">   ▄█▀   </span><span style="color:#E0E0E0">▄▄▄▄     ▄▄▄▄</span><span style="color:#FFFFFF">   ▀█▄   </span>
<span style="color:#FFFFFF">  █▀  </span><span style="color:#D0D0D0">▄█▀▀▀▀▀█   █▀▀▀▀▀█▄</span><span style="color:#FFFFFF">  ▀█  </span>
<span style="color:#FFFFFF"> █▀  </span><span style="color:#C0C0C0">█▀       ▀ ▀       ▀█</span><span style="color:#FFFFFF">  ▀█ </span>
<span style="color:#FFFFFF">█▀ </span><span style="color:#B0B0B0">▄▀                     ▀▄</span><span style="color:#FFFFFF"> ▀█</span>
<span style="color:#FFFFFF">█  </span><span style="color:#A0A0A0">  ▐▐▓▓▌▐        ▐▐▓▓▌▐   </span><span style="color:#FFFFFF"> █</span>
<span style="color:#FFFFFF">█  </span><span style="color:#909090">   ▐▓▓▌          ▐▓▓▌    </span><span style="color:#FFFFFF">█</span>
<span style="color:#FFFFFF">█  </span><span style="color:#808080">    ▀▀    ▐▓▓▌    ▀▀     </span><span style="color:#FFFFFF">█</span>
<span style="color:#FFFFFF">█  </span><span style="color:#707070">          ▐  ▌           </span><span style="color:#FFFFFF">█</span>
<span style="color:#FFFFFF">█  </span><span style="color:#606060">                          </span><span style="color:#FFFFFF">█</span>
<span style="color:#FFFFFF">█▄ </span><span style="color:#505050">                        </span><span style="color:#FFFFFF">▄█</span>
<span style="color:#FFFFFF">▀█  </span><span style="color:#404040"> ▐▓▓              ▓▓▌ </span><span style="color:#FFFFFF"> █▀</span>
<span style="color:#FFFFFF"> ▀█  </span><span style="color:#303030">  ▀▓▓▓▀▀▀▀▀▀▀▀▓▓▓▀  </span><span style="color:#FFFFFF"> █▀ </span>
<span style="color:#FFFFFF">  ▀█▄ </span><span style="color:#202020">                  </span><span style="color:#FFFFFF">▄█▀  </span>
<span style="color:#FFFFFF">    ▀█▄ </span><span style="color:#101010">              </span><span style="color:#FFFFFF">▄█▀    </span>
<span style="color:#FFFFFF">      ▀▀██████████████▀▀      </span>
    `,
                'Deep One': `
<span style="color:#005959">        ▄▄▄▄▄▄        </span>
<span style="color:#005959">      ▄█▀▀▀▀▀▀█▄      </span>
<span style="color:#005959">    ▄█▀░░</span><span style="color:#008080">▒▒▒▒</span><span style="color:#005959">░░▀█▄    </span>
<span style="color:#005959">  ▄█▀░</span><span style="color:#008080">▒▒</span><span style="color:#00A0A0">▄▄▄▄▄▄</span><span style="color:#008080">▒▒</span><span style="color:#005959">░▀█▄  </span>
</span><span style="color:#008080">▒</span><span style="color:#00A0A0">▄</span><span style="color:#FF0000">(@@)</span><span style="color:#00A0A0">░░░░░░░░</span><span style="color:#FF0000">(@@)</span><span style="color:#00A0A0">▄</span><span style="color:#008080">▒</span></span>
<span style="color:#005959">█▀░</span><span style="color:#008080">▒</span><span style="color:#00BFBF">█▀░░░░░░░░▀█</span><span style="color:#008080">▒</span><span style="color:#005959">░▀█</span>
<span style="color:#005959">█░</span><span style="color:#008080">▒</span><span style="color:#00DFDF">█░▄▀▀▀▀▀▀▄░█</span><span style="color:#008080">▒</span><span style="color:#005959">░█</span>
<span style="color:#005959">█░</span><span style="color:#008080">▒</span><span style="color:#00FFFF">█░█░</span><span style="color:#40E0D0">_\\/_</span><span style="color:#00FFFF">░█░█</span><span style="color:#008080">▒</span><span style="color:#005959">░█</span>
<span style="color:#005959">█░</span><span style="color:#008080">▒</span><span style="color:#00DFDF">▀█▄▀</span><span style="color:#40E0D0">/,\\,\\</span><span style="color:#00DFDF">▀▄█▀</span><span style="color:#008080">▒</span><span style="color:#005959">░█</span>
<span style="color:#005959">█▄░</span><span style="color:#008080">▒▒</span><span style="color:#00BFBF">▀▄</span><span style="color:#40E0D0">'-'</span><span style="color:#00BFBF">▄▀</span><span style="color:#008080">▒▒</span><span style="color:#005959">░▄█</span>
<span style="color:#005959"> ██▄░░</span><span style="color:#008080">▒▒▒▒▒▒</span><span style="color:#005959">░░▄██ </span>
<span style="color:#005959">  ▀██▄▄░░░░░░▄▄██▀  </span>
<span style="color:#005959">    ▀▀████████▀▀    </span>
<span style="color:#008080">  ▄█▀▀▄</span><span style="color:#00A0A0">▓▓▓▓▓▓▓▓</span><span style="color:#008080">▄▀▀█▄  </span>
<span style="color:#008080"> █▀ </span><span style="color:#00BFBF">▄▓▓▓▀▀▀▀▓▓▓▄</span><span style="color:#008080"> ▀█ </span>
<span style="color:#008080">█  </span><span style="color:#00DFDF">▓▓▓▀▄▄▄▄▀▓▓▓</span><span style="color:#008080">  █</span>
<span style="color:#008080">▀█▄▄</span><span style="color:#00FFFF">▓▓▓▓▓▓▓▓▓▓</span><span style="color:#008080">▄▄█▀</span>
    `,
                'Byakhee': `
<span style="color:#8B4513">                  ▄▄▄▄▄▄▄              </span>
<span style="color:#8B4513">               ▄█▀▀░░░░▀▀█▄           </span>
<span style="color:#8B4513">           ▄█▀░▒▒</span><span style="color:#FF0000">◉</span><span style="color:#8B4513">▒▒▄▄░░░░▀█         </span>
<span style="color:#8B4513">         ▄█▀░▒▒▒▄█▀▀█ ▒▒░░▀▄   </span>
<span style="color:#8B4513">       ▄█▀░▒▒▒▄█▀░░░▄ ░░░░░ ▄   </span>
<span style="color:#8B4513">     ▄█▀░▒▒▒▄█▀░░░▒ ▄▀░▄▄░░▀  </span>
<span style="color:#A0522D">   ▄█▀░▄▄▄██▀░░▒▒  ▀▄▀░▀▀░░▀ </span>
<span style="color:#A0522D"> ▄█▀▄█▀▀▀░░░▒▒▒░   ▀▄░░░░░▄▀  </span>
<span style="color:#A0522D">█▀▄█▀░░▒▒▒▒▒▒▒░░░   ▀▄░░▄▀    </span>
<span style="color:#CD853F"> █▀█░▒▒▒▒▒▒░░░       ▀▀      </span>
<span style="color:#CD853F"> ██░▒▒▒▒▒░░░                    </span>
<span style="color:#CD853F"> █▄░▒▒▒▒                     </span>
<span style="color:#CD853F">  █▄░░▒▒▒▄▄░                      </span>
<span style="color:#DEB887">   █▄░░▄█▀▒                       </span>
<span style="color:#DEB887">    █▄█▀░▒                        </span>
<span style="color:#DEB887">     █▄░                         </span>
<span style="color:#DEB887">      ▀█▄▄▄▄█▀                        </span>
    `,
                'Elder Thing': `
<span style="color:#8B4513">     </span><span style="color:#FF4500">(@)</span><span style="color:#A0522D">╚═╗</span><span style="color:#FF4500">(@)</span><span style="color:#A0522D">╔═╝</span><span style="color:#FF4500">(@)</span><span style="color:#8B4513">     </span>
<span style="color:#8B4513">      </span><span style="color:#A0522D">╚  ║  ╝</span><span style="color:#8B4513">      </span>
<span style="color:#8B4513">       </span><span style="color:#A0522D">╚ ║ ╝</span><span style="color:#8B4513">       </span>
<span style="color:#8B4513">    </span><span style="color:#FF4500">(@)</span><span style="color:#CD853F">╗╚ ║ ╝╔</span><span style="color:#FF4500">(@)</span><span style="color:#8B4513">    </span>
<span style="color:#8B4513">      </span><span style="color:#CD853F">╔ ╚╦╝ ╗</span><span style="color:#8B4513">      </span>
<span style="color:#704214">     ▄▄</span><span style="color:#8B4513">█████</span><span style="color:#704214">▄▄     </span>
<span style="color:#704214">    ██</span><span style="color:#8B4513">▒█</span><span style="color:#FF4500">(@)</span><span style="color:#8B4513">█▒</span><span style="color:#704214">██    </span>
<span style="color:#704214">   ██</span><span style="color:#8B4513">▒███████▒</span><span style="color:#704214">██   </span>
<span style="color:#36648B"> ▄█</span><span style="color:#704214">█</span><span style="color:#8B4513">▒███████▒</span><span style="color:#704214">█</span><span style="color:#36648B">█▄ </span>
<span style="color:#36648B">█▀</span><span style="color:#704214">██</span><span style="color:#8B4513">▒█████▒</span><span style="color:#704214">██</span><span style="color:#36648B">▀█</span>
<span style="color:#36648B">▀█▄</span><span style="color:#704214">██</span><span style="color:#8B4513">▒███▒</span><span style="color:#704214">██</span><span style="color:#36648B">▄█▀</span>
<span style="color:#36648B">  ▀█▄██████████▄█▀  </span>
<span style="color:#36648B">    ▀▀█▄▄▄▄▄█▀▀    </span>
<span style="color:#4682B4">  ▄▄██▀     ▀██▄▄  </span>
<span style="color:#4682B4"> ██▀           ▀██ </span>
<span style="color:#4682B4">█▀               ▀█</span>
<span style="color:#4682B4">█▄   ▄       ▄   ▄█</span>
<span style="color:#4682B4"> ▀██▀ ▀     ▀ ▀██▀ </span>
    `,
                'Star Spawn': `
<span style="color:#2A0A29">      ▄████▄      </span>
<span style="color:#2A0A29">    ▄█▀</span><span style="color:#FF1493">◉</span><span style="color:#2A0A29">▀██▀</span><span style="color:#FF1493">◉</span><span style="color:#2A0A29">▀█▄    </span>
<span style="color:#2A0A29">   █▀ </span><span style="color:#4B0082">▄▄██▄▄</span><span style="color:#2A0A29"> ▀█   </span>
<span style="color:#2A0A29">  █▀ </span><span style="color:#4B0082">█</span><span style="color:#FF1493">◉</span><span style="color:#4B0082">█</span><span style="color:#2A0A29">▀▀</span><span style="color:#4B0082">█</span><span style="color:#FF1493">◉</span><span style="color:#4B0082">█</span><span style="color:#2A0A29"> ▀█  </span>
<span style="color:#2A0A29"> █▀ </span><span style="color:#6A0DAD">█▄▀▀▀▀▄█</span><span style="color:#2A0A29"> ▀█ </span>
<span style="color:#2A0A29">█▀ </span><span style="color:#8A2BE2">█▀▄</span><span style="color:#FF1493">◉</span><span style="color:#8A2BE2">▄</span><span style="color:#FF1493">◉</span><span style="color:#8A2BE2">▄▀█</span><span style="color:#2A0A29"> ▀█</span>
<span style="color:#2A0A29">█ </span><span style="color:#9370DB">▄█████████▄</span><span style="color:#2A0A29"> █</span>
<span style="color:#2A0A29">█ </span><span style="color:#BA55D3">███▀▀▀▀▀███</span><span style="color:#2A0A29"> █</span>
<span style="color:#2A0A29">█ </span><span style="color:#DA70D6">██▀  ▄  ▀██</span><span style="color:#2A0A29"> █</span>
<span style="color:#2A0A29">█ </span><span style="color:#EE82EE">██  </span><span style="color:#FF1493"> ◉</span><span style="color:#EE82EE">   ██</span><span style="color:#2A0A29"> █</span>
<span style="color:#2A0A29">█▄ </span><span style="color:#DA70D6">██▄   ▄██</span><span style="color:#2A0A29"> ▄█</span>
<span style="color:#2A0A29">▀█▄ </span><span style="color:#BA55D3">▀██▄▄▄██▀</span><span style="color:#2A0A29"> ▄█▀</span>
<span style="color:#2A0A29"> ▀█▄▄ </span><span style="color:#9370DB">▀▀▀▀▀</span><span style="color:#2A0A29"> ▄▄█▀ </span>
<span style="color:#2A0A29">   ▀▀█▄▄▄▄▄█▀▀   </span>
<span style="color:#4B0082"> ▄▄██▀▀▀▀▀▀▀██▄▄ </span>
<span style="color:#6A0DAD">█▀▀ ▄▄▄▄▄▄▄ ▀▀█</span>
<span style="color:#8A2BE2">█ ▄▀       ▀▄ █</span>
<span style="color:#9370DB">▀█▀         ▀█▀</span>
    `,
                'Mossman': `
    <span style="color:#004400">      ▄▄████████▄▄      </span>
<span style="color:#006600">    ▄█▀▀░░░░░░░░▀▀█▄    </span>
<span style="color:#008800">   █▀ ▄</span><span style="color:#FF0000">▓▓</span><span style="color:#008800">▄░░░░▄</span><span style="color:#FF0000">▓▓</span><span style="color:#008800">▄ ▀█   </span>
<span style="color:#00AA00">  █░ █▀▀▀▀░░░░▀▀▀▀█ ░█  </span>
<span style="color:#00CC00">  █░ █░░</span><span style="color:#008800">▄▄██▄▄</span><span style="color:#00CC00">░░█ ░█  </span>
<span style="color:#00EE00"> ▄▀░ █░</span><span style="color:#008800">█▄▄██▄▄█</span><span style="color:#00EE00">░█ ░▀▄ </span>
<span style="color:#00FF00"> █░░ █░█ ░░▀░░ █░█ ░░█ </span>
<span style="color:#22FF22"> █░░ █░███▄░░▄███░█ ░░█ </span>
<span style="color:#44FF44"> █░░ ▀░██▀▀░░▀▀██░▀ ░░█ </span>
<span style="color:#66FF66"> █░░░ ░███▄▄▄▄███░ ░░░█ </span>
<span style="color:#88FF88"> ▀▄░░░░▀▀███████▀▀░░░▄▀ </span>
<span style="color:#AAFFAA">  ▀▄░░░░░░░░░░░░░░░░▄▀  </span>
<span style="color:#CCFFCC">   ▀▄░░░░░░░░░░░░░░▄▀   </span>
<span style="color:#EEFFEE">    ▀█▄░░░░░░░░░░▄█▀    </span>
<span style="color:#FFFFFF">      ▀█▄▄░░░░▄▄█▀      </span>
<span style="color:#EEFFEE">     ▄█▀   ▀▀▀▀    ▀█▄     </span>
<span style="color:#CCFFCC">   █▀   ▄█▀▀▀▀▀▀█▄  ▀█    </span>

    `,
                'Mi-go': `
<span style="color:#8B0000">        ▄▄████▄▄        </span>
<span style="color:#8B0000">      ▄█▀</span><span style="color:#00FF00">◉</span><span style="color:#8B0000">▀▀▀▀▀</span><span style="color:#00FF00">◉</span><span style="color:#8B0000">▀█▄      </span>
<span style="color:#8B0000">    ▄█▀▀█▄▄▄▄▄▄▄█▀▀█▄    </span>
<span style="color:#8B0000">  ▄█▀  ▄████████████▄ ▀█▄  </span>
<span style="color:#8B0000">▄█▀ ▄███▀▀▀▀▀▀▀▀▀███▄ ▀█▄</span>
<span style="color:#A52A2A">█▄▄███▀  </span><span style="color:#228B22">▄▄▄▄▄▄</span><span style="color:#A52A2A">  ▀███▄▄█</span>
<span style="color:#A52A2A">█▀██▀   </span><span style="color:#32CD32">▄▀</span><span style="color:#B22222">█</span><span style="color:#32CD32">░░░▀▄</span><span style="color:#A52A2A">   ▀██▀█</span>
<span style="color:#B22222">█ ▀█   </span><span style="color:#3CB371">█ ▄▄█▄▄ █</span><span style="color:#B22222">   █▀ █</span>
<span style="color:#CD5C5C">█  ▀   </span><span style="color:#66CDAA">▀▄▀██▀▄▀</span><span style="color:#CD5C5C">   ▀  █</span>
<span style="color:#FF6347">█▄   ▄▄▄▀▀▄▄▄▄▀▀▄▄▄   ▄█</span>
<span style="color:#FF6347">▀█▄▄█▀▀█▄▄  ▄▄█▀▀█▄▄█▀</span>
<span style="color:#FF7F50"> ▀█▄  ▀▀▀▀▀▀▀▀▀▀  ▄█▀ </span>
<span style="color:#FF7F50">   ▀█▄▄ ▀▀▀▀▀▀ ▄▄█▀   </span>
<span style="color:#FFA07A">     ▀█ █ ▄▄ █ █▀     </span>
<span style="color:#FFA07A">      █ █ ▀▀ █ █      </span>
<span style="color:#FFB6C1">      █ █    █ █      </span>
<span style="color:#FFB6C1">      ▀▄▀    ▀▄▀      </span>
<span style="color:#FFC0CB">       ▀      ▀       </span>
    `,
                'Nightgaunt': `
<span style="color:#000080">  ▄▄</span><span style="color:#0000CD">▀▀</span><span style="color:#000080">▄▄    ▄▄</span><span style="color:#0000CD">▀▀</span><span style="color:#000080">▄▄  </span>
<span style="color:#000080"> ▄</span><span style="color:#0000CD">▀</span><span style="color:#000080">█ </span><span style="color:#0000CD">▄▄▄▄</span><span style="color:#000080"> █</span><span style="color:#0000CD">▀</span><span style="color:#000080">▄ </span>
<span style="color:#000080">█▀ </span><span style="color:#0000CD">█▀▀▀▀▀▀█</span><span style="color:#000080"> ▀█</span>
<span style="color:#000080">█  </span><span style="color:#4169E1">█ ▄▄▄▄ █</span><span style="color:#000080">  █</span>
<span style="color:#000080">█ </span><span style="color:#4169E1">█▀▄▀▀▀▄▀█</span><span style="color:#000080"> █</span>
<span style="color:#000080">█ </span><span style="color:#6495ED">█ ▀▄▄▄▀ █</span><span style="color:#000080"> █</span>
<span style="color:#000080">█ </span><span style="color:#6495ED">▀█▄▄▄▄▄█▀</span><span style="color:#000080"> █</span>
<span style="color:#000080">█ </span><span style="color:#87CEFA">███▀▀▀███</span><span style="color:#000080"> █</span>
<span style="color:#000080">█ </span><span style="color:#87CEFA">██▀   ▀██</span><span style="color:#000080"> █</span>
<span style="color:#000080">█ </span><span style="color:#ADD8E6">██  ▄  ██</span><span style="color:#000080"> █</span>
<span style="color:#000080">▀█▄ </span><span style="color:#E6E6FA">▀█▄▄▄█▀</span><span style="color:#000080"> ▄█▀</span>
<span style="color:#000080"> ▀█▄▄ </span><span style="color:#E6E6FA">▀▀▀</span><span style="color:#000080"> ▄▄█▀ </span>
<span style="color:#000080">   ▀█▄▄   ▄▄█▀   </span>
<span style="color:#191970">     ▀█   █▀     </span>
<span style="color:#191970">      █   █      </span>
<span style="color:#191970">      █   █      </span>
<span style="color:#191970">      █▄ ▄█      </span>
<span style="color:#191970">       ▀▀▀       </span>
    `,
                'Uroboros': `
<span style="color:#004000">         ▄▄▄▄▄▄▄▄         </span>
<span style="color:#004000">     ▄▄█▀</span><span style="color:#008000">▀▀▀▀▀</span><span style="color:#004000">▀▀█▄▄     </span>
<span style="color:#004000">   ▄█▀</span><span style="color:#008000">░░░░░░░░░░░░░░░░</span><span style="color:#004000">▀█▄   </span>
<span style="color:#004000"> ▄█</span><span style="color:#008000">░░░░░░░▄▄▄▄▄▄▄▄▄▄░░░░░░░░</span><span style="color:#004000">█▄ </span>
<span style="color:#004000">█▀</span><span style="color:#008000">░░░░▄▄█▀▀</span><span style="color:#00FF00">░░░░░░░░░</span><span style="color:#008000">▀▀█▄▄░░░░</span><span style="color:#004000">▀█</span>
<span style="color:#004000">█</span><span style="color:#008000">░░▄█▀░</span><span style="color:#00FF00">░░░░░░░░░░░░░░░░░</span><span style="color:#008000">▀█▄░░</span><span style="color:#004000">█</span>
<span style="color:#004000">█</span><span style="color:#008000">░█▀</span><span style="color:#00FF00">░░░░░░░░</span><span style="color:#FFD700">▄▄▄▄▄▄▄</span><span style="color:#00FF00">░░░░░░░░</span><span style="color:#008000">▀█░</span><span style="color:#004000">█</span>
<span style="color:#004000">█</span><span style="color:#008000">█░</span><span style="color:#00FF00">░░░░░░░</span><span style="color:#FFD700">▄█████████▄</span><span style="color:#00FF00">░░░░░░░</span><span style="color:#008000">░█</span><span style="color:#004000">█</span>
<span style="color:#004000">█</span><span style="color:#00FF00">░░░░░░░░</span><span style="color:#FFD700">██▀░</span><span style="color:#FFD700">　░▀██</span><span style="color:#00FF00">░░░░░░░░</span><span style="color:#004000">█</span>
<span style="color:#004000">█</span><span style="color:#00FF00">░░░░░░░░</span><span style="color:#FFD700">██░░░░　　　░░░░██</span><span style="color:#00FF00">░░░░░░░░</span><span style="color:#004000">█</span>
<span style="color:#004000">█</span><span style="color:#00FF00">░░░░░░░░░</span><span style="color:#FFD700">██▄░░░　░░░▄██</span><span style="color:#00FF00">░░░░░░░░░</span><span style="color:#004000">█</span>
<span style="color:#004000">█</span><span style="color:#008000">█</span><span style="color:#00FF00">░░░░░░░░</span><span style="color:#FFD700">▀███████▀</span><span style="color:#00FF00">░░░░░░░░</span><span style="color:#008000">█</span><span style="color:#004000">█</span>
<span style="color:#004000">█</span><span style="color:#008000">░█▄</span><span style="color:#00FF00">░░░░░░░░░░░░░░░░░░░░░░</span><span style="color:#008000">▄█░</span><span style="color:#004000">█</span>
<span style="color:#004000">█</span><span style="color:#008000">░░░▀█▄░░░░░░░░░░░░░░░░░░░▄█▀░░</span><span style="color:#004000">█</span>
<span style="color:#004000">▄</span><span style="color:#008000">░░░░░▀▀█▄▄░░░░░░░░░░▄▄█▀▀░░░░</span><span style="color:#004000">▄█</span>
<span style="color:#004000"> ▀█▄</span><span style="color:#008000">░░░░░░░░▀▀▀██████▀▀▀░░░░░░░</span><span style="color:#004000">▄█▀ </span>
<span style="color:#004000">   ▀█▄▄</span><span style="color:#008000">░░░░░░░░░░░░░░░</span><span style="color:#004000">▄▄█▀   </span>
<span style="color:#004000">     ▀▀█▄▄▄▄▄▄▄▄▄▄▄█▀▀     </span>
    `,

                'Novice Explorer': `


<span style="color:#8B4513">     ▄████████▄     </span>
<span style="color:#8B4513">   ▄█▀</span><span style="color:#A0522D">░░░░░░░░</span><span style="color:#8B4513">▀█▄   </span>
<span style="color:#8B4513">  █▀</span><span style="color:#CD853F">░░</span><span style="color:#FFD700">▄▄▄▄▄▄▄▄</span><span style="color:#CD853F">░░</span><span style="color:#8B4513">▀█  </span>
<span style="color:#8B4513"> █</span><span style="color:#CD853F">░░</span><span style="color:#FFD700">▄█</span><span style="color:#000000">●</span><span style="color:#FFD700">█░░█</span><span style="color:#000000">●</span><span style="color:#FFD700">█▄</span><span style="color:#CD853F">░░</span><span style="color:#8B4513">█ </span>
<span style="color:#8B4513"> █</span><span style="color:#CD853F">░</span><span style="color:#FFD700">█░</span><span style="color:#DEB887">░░░░░░░░</span><span style="color:#FFD700">░█</span><span style="color:#CD853F">░</span><span style="color:#8B4513">█ </span>
<span style="color:#8B4513"> █</span><span style="color:#CD853F">░</span><span style="color:#FFD700">█░░░</span><span style="color:#B8860B">\___/</span><span style="color:#FFD700">░░░█</span><span style="color:#CD853F">░</span><span style="color:#8B4513">█ </span>
<span style="color:#8B4513"> █</span><span style="color:#CD853F">░░</span><span style="color:#FFD700">▀█░░░░░░░█▀</span><span style="color:#CD853F">░░</span><span style="color:#8B4513">█ </span>
<span style="color:#8B4513"> █▄░░</span><span style="color:#FFD700">▀▀█▄▄▄█▀▀</span><span style="color:#CD853F">░░▄█ </span>
<span style="color:#8B4513">  ▀█▄░░</span><span style="color:#DAA520">▀▀▀▀▀</span><span style="color:#CD853F">░░▄█▀  </span>
<span style="color:#8B4513">    ▀█▄▄░░░░░▄▄█▀    </span>


    `,
                'Seasoned Investigator': `
<span style="color:#8B4513">     ▄▄▄▄▄▄▄▄     </span>
<span style="color:#8B4513">   ▄█▀</span><span style="color:#A0522D">░░░░░░</span><span style="color:#8B4513">▀█▄   </span>
<span style="color:#8B4513">  █▀ </span><span style="color:#B8860B">▄▄▄▄▄▄▄▄</span><span style="color:#8B4513"> ▀█  </span>
<span style="color:#8B4513"> █▀ </span><span style="color:#B8860B">█</span><span style="color:#000000">●</span><span style="color:#B8860B">▀▀▀▀</span><span style="color:#000000">●</span><span style="color:#B8860B">█</span><span style="color:#8B4513"> ▀█ </span>
<span style="color:#8B4513">█▀ </span><span style="color:#B8860B">█  ▄██▄  █</span><span style="color:#8B4513"> ▀█</span>
<span style="color:#8B4513">█ </span><span style="color:#B8860B">▄█████████▄</span><span style="color:#8B4513"> █</span>
<span style="color:#8B4513">█ </span><span style="color:#DAA520">███▀▀▀▀▀███</span><span style="color:#8B4513"> █</span>
<span style="color:#8B4513">█ </span><span style="color:#DAA520">██▀ </span><span style="color:#CD853F">╱╲</span><span style="color:#DAA520"> ▀██</span><span style="color:#8B4513"> █</span>
<span style="color:#8B4513">█ </span><span style="color:#DAA520">██  </span><span style="color:#CD853F">││</span><span style="color:#DAA520">  ██</span><span style="color:#8B4513"> █</span>
<span style="color:#8B4513">█▄ </span><span style="color:#DAA520">██▄ </span><span style="color:#CD853F">╲╱</span><span style="color:#DAA520"> ▄██</span><span style="color:#8B4513"> ▄█</span>
<span style="color:#8B4513">▀█▄ </span><span style="color:#B8860B">▀██▄▄▄██▀</span><span style="color:#8B4513"> ▄█▀</span>
<span style="color:#8B4513"> ▀█▄▄ </span><span style="color:#B8860B">▀▀▀▀▀</span><span style="color:#8B4513"> ▄▄█▀ </span>
<span style="color:#8B4513">   ▀▀█████████▀▀   </span>

    `,
                'Arcane Scholar': `
<span style="color:#4B0082">      ▄▄▄▄▄▄      </span>
<span style="color:#4B0082">    ▄█▀</span><span style="color:#6A5ACD">░░░░</span><span style="color:#4B0082">▀█▄    </span>
<span style="color:#4B0082">   █▀</span><span style="color:#8A2BE2">▄</span><span style="color:#000000">◙</span><span style="color:#8A2BE2">▀▀▀▀</span><span style="color:#000000">◙</span><span style="color:#8A2BE2">▄</span><span style="color:#4B0082">▀█   </span>
<span style="color:#4B0082">  █▀</span><span style="color:#8A2BE2">█ ▄▄▄▄▄▄ █</span><span style="color:#4B0082">▀█  </span>
<span style="color:#4B0082"> █▀</span><span style="color:#8A2BE2">▄█▀▀▀▀▀▀▀█▄</span><span style="color:#4B0082">▀█ </span>
<span style="color:#4B0082">█▀</span><span style="color:#8A2BE2">█▀  ▄▄▄▄  ▀█</span><span style="color:#4B0082">▀█</span>
<span style="color:#4B0082">█</span><span style="color:#8A2BE2">█   █▄▄█   █</span><span style="color:#4B0082">█</span>
<span style="color:#4B0082">█</span><span style="color:#9370DB">█▄  ▀▀▀▀  ▄█</span><span style="color:#4B0082">█</span>
<span style="color:#4B0082">█</span><span style="color:#9370DB">██▄  ▀▀  ▄██</span><span style="color:#4B0082">█</span>
<span style="color:#4B0082">█</span><span style="color:#9370DB">███▄    ▄███</span><span style="color:#4B0082">█</span>
<span style="color:#4B0082">█▄</span><span style="color:#9370DB">████████████</span><span style="color:#4B0082">▄█</span>
<span style="color:#4B0082">▀█▄</span><span style="color:#9370DB">██████████</span><span style="color:#4B0082">▄█▀</span>
<span style="color:#4B0082"> ▀██▄▄▄▄▄▄▄▄▄██▀ </span>
<span style="color:#4B0082">   ▀▀█████████▀▀   </span>
    `,
                'Occult Detective': `
<span style="color:#2F4F4F">     ▄▄▄▄▄▄▄▄     </span>
<span style="color:#2F4F4F">   ▄█▀</span><span style="color:#708090">░░░░░░</span><span style="color:#2F4F4F">▀█▄   </span>
<span style="color:#2F4F4F">  █▀ </span><span style="color:#778899">▄▄▄▄▄▄▄▄</span><span style="color:#2F4F4F"> ▀█  </span>
<span style="color:#2F4F4F"> █▀ </span><span style="color:#778899">█</span><span style="color:#A9A9A9">▒▒▒▒▒▒</span><span style="color:#778899">█</span><span style="color:#2F4F4F"> ▀█ </span>
<span style="color:#2F4F4F">█▀ </span><span style="color:#778899">█</span><span style="color:#A9A9A9">▒</span><span style="color:#000000">○   ○</span><span style="color:#A9A9A9">▒</span><span style="color:#778899">█</span><span style="color:#2F4F4F"> ▀█</span>
<span style="color:#2F4F4F">█ </span><span style="color:#778899">▄█</span><span style="color:#A9A9A9">▒</span><span style="color:#000000">  ‿</span><span style="color:#A9A9A9">▒▒</span><span style="color:#778899">█▄</span><span style="color:#2F4F4F"> █</span>
<span style="color:#2F4F4F">█ </span><span style="color:#4B0082">███▀▀▀▀▀███</span><span style="color:#2F4F4F"> █</span>
<span style="color:#2F4F4F">█ </span><span style="color:#4B0082">██▀ </span><span style="color:#6A5ACD">▄▄</span><span style="color:#4B0082"> ▀██</span><span style="color:#2F4F4F"> █</span>
<span style="color:#2F4F4F">█ </span><span style="color:#4B0082">██  </span><span style="color:#6A5ACD">▀▀</span><span style="color:#4B0082">  ██</span><span style="color:#2F4F4F"> █</span>
<span style="color:#2F4F4F">█ </span><span style="color:#4B0082">██▄ </span><span style="color:#6A5ACD">╱╲</span><span style="color:#4B0082"> ▄██</span><span style="color:#2F4F4F"> █</span>
<span style="color:#2F4F4F">█▄</span><span style="color:#4B0082">███████████</span><span style="color:#2F4F4F">▄█</span>
<span style="color:#2F4F4F">▀█▄</span><span style="color:#4B0082">█████████</span><span style="color:#2F4F4F">▄█▀</span>
<span style="color:#2F4F4F"> ▀██▄▄▄▄▄▄▄▄▄██▀ </span>
<span style="color:#2F4F4F">   ▀▀█████████▀▀   </span>
    `,
                'Eldritch Archaeologist': `
<span style="color:#556B2F">      ▄▄▄▄▄▄      </span>
<span style="color:#556B2F">    ▄█▀</span><span style="color:#6B8E23">░░░░</span><span style="color:#556B2F">▀█▄    </span>
<span style="color:#556B2F">   █▀</span><span style="color:#9ACD32">▄</span><span style="color:#000000">◙</span><span style="color:#9ACD32">▀▀▀▀</span><span style="color:#000000">◙</span><span style="color:#9ACD32">▄</span><span style="color:#556B2F">▀█   </span>
<span style="color:#556B2F">  █▀</span><span style="color:#9ACD32">█ ▄▄▄▄▄▄ █</span><span style="color:#556B2F">▀█  </span>
<span style="color:#556B2F"> █▀</span><span style="color:#9ACD32">▄█▀▀▀▀▀▀▀█▄</span><span style="color:#556B2F">▀█ </span>
<span style="color:#556B2F">█▀</span><span style="color:#9ACD32">█▀  </span><span style="color:#000000">◉   ◉</span><span style="color:#9ACD32">  ▀█</span><span style="color:#556B2F">▀█</span>
<span style="color:#556B2F">█</span><span style="color:#9ACD32">█    </span><span style="color:#000000">  ◡</span><span style="color:#9ACD32">    █</span><span style="color:#556B2F">█</span>
<span style="color:#556B2F">█</span><span style="color:#8FBC8F">█▄  ▀▀▀▀  ▄█</span><span style="color:#556B2F">█</span>
<span style="color:#556B2F">█</span><span style="color:#8FBC8F">██▄  ▀▀  ▄██</span><span style="color:#556B2F">█</span>
<span style="color:#556B2F">█</span><span style="color:#8FBC8F">███▄    ▄███</span><span style="color:#556B2F">█</span>
<span style="color:#556B2F">█▄</span><span style="color:#8FBC8F">████████████</span><span style="color:#556B2F">▄█</span>
<span style="color:#556B2F">▀█▄</span><span style="color:#8FBC8F">██████████</span><span style="color:#556B2F">▄█▀</span>
<span style="color:#556B2F"> ▀██▄▄▄▄▄▄▄▄▄██▀ </span>
<span style="color:#556B2F">   ▀▀█████████▀▀   </span>
    `,
                'Cosmic Voyager': `
<span style="color:#191970">      ▄▄█▀▀█▄▄      </span>
<span style="color:#191970">    ▄█▀</span><span style="color:#000080">░░░░░░</span><span style="color:#191970">▀█▄    </span>
<span style="color:#191970">   █▀░</span><span style="color:#4169E1">▄▄███▄▄</span><span style="color:#191970">░▀█   </span>
<span style="color:#191970">  █░</span><span style="color:#4169E1">█</span><span style="color:#191970">▒</span><span style="color:#FF4500">(@)</span><span style="color:#191970">▒</span><span style="color:#4169E1">█</span><span style="color:#191970">▒</span><span style="color:#FF4500">(@)</span><span style="color:#191970">▒</span><span style="color:#4169E1">█</span><span style="color:#191970">░█  </span>
<span style="color:#191970"> █░</span><span style="color:#4169E1">█▀▄</span><span style="color:#191970">▒▒▒</span><span style="color:#4169E1">▄▀█</span><span style="color:#191970">░█ </span>
<span style="color:#191970">█░</span><span style="color:#4169E1">▄█▀░</span><span style="color:#191970">▒▒▒</span><span style="color:#4169E1">░▀█▄</span><span style="color:#191970">░█</span>
<span style="color:#191970">█░</span><span style="color:#6495ED">█▄▄██████▄▄█</span><span style="color:#191970">░█</span>
<span style="color:#191970">█░</span><span style="color:#6495ED">███████████</span><span style="color:#191970">░█</span>
<span style="color:#191970">█░░</span><span style="color:#6495ED">█████████</span><span style="color:#191970">░░█</span>
<span style="color:#191970">█▄░░</span><span style="color:#6495ED">███████</span><span style="color:#191970">░░▄█</span>
<span style="color:#191970"> █▀▄▄░░░░░░░▄▄▀█ </span>
<span style="color:#191970"> ▀█░░▀▀▀▀▀▀░░█▀ </span>
<span style="color:#191970">  ▀█▄░░░░░░▄█▀  </span>
<span style="color:#191970">    ▀▀█▄▄▄█▀▀    </span>
    `
            };

            function toggleStatisticsModal() {
                const modal = document.getElementById('statisticsModal');
                const statsButton = document.getElementById('statisticsButton');

                if (modal.classList.contains('active')) {
                    // モーダルを閉じる
                    modal.classList.remove('active');
                    statsButton.classList.remove('active');
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 300); // トランジション時間後に非表示
                } else {
                    // モーダルを開く
                    modal.style.display = 'block';
                    updateStatistics(); // 統計を更新
                    requestAnimationFrame(() => {
                        modal.classList.add('active');
                        statsButton.classList.add('active');
                    });
                }
            }

            // 既存のshowStatisticsModal関数を置き換え
            function showStatisticsModal() {
                toggleStatisticsModal();
            }

            // 既存のcloseStatisticsModal関数を置き換え
            function closeStatisticsModal() {
                toggleStatisticsModal();
            }

            // 統計ボタンを再作成
            const topButtons = document.getElementById('top-buttons');
            const existingStatsButton = document.getElementById('statisticsButton');
            if (!existingStatsButton) {
                const statsButton = document.createElement('button');
                statsButton.id = 'statisticsButton';
                statsButton.textContent = 'Statistics';
                statsButton.onclick = toggleStatisticsModal;
                topButtons.insertBefore(statsButton, topButtons.firstChild);
            }

            // モーダル外クリックでの閉じる処理を改善
            document.getElementById('statisticsModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    toggleStatisticsModal();
                }
            });

            // ESCキーでモーダルを閉じる
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && document.getElementById('statisticsModal').classList.contains('active')) {
                    toggleStatisticsModal();
                }
            });

            // 初期状態で非表示に設定
            document.addEventListener('DOMContentLoaded', function () {
                const modal = document.getElementById('statisticsModal');
                modal.style.display = 'none';
                modal.classList.remove('active');
            });

            // スクロールに応じてボタンの表示/非表示を切り替える関数
            function scrollFunction() {
                const backToTopBtn = document.getElementById("backToTopBtn");
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    backToTopBtn.style.display = "block";
                } else {
                    backToTopBtn.style.display = "none";
                }
            }

            // ページトップへスクロールする関数
            function backToTop() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
            }

            // イベントリスナーの設定
            window.onscroll = function () { scrollFunction() };

            function setEmblem() {
                const emblem = document.getElementById('emblem');
                emblem.innerHTML = `
<span class="emblem-color2">   ╔════════════════════════════════════════════════════╗   </span>
<span class="emblem-color2"> ╔═╝</span><span class="emblem-color1">  ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄  </span><span class="emblem-color2">╚═╗ </span>
<span class="emblem-color2">╔╝</span><span class="emblem-color1"> ▐█</span><span class="emblem-color2">░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class="emblem-color1">█▌ </span><span class="emblem-color2">╚╗</span>
<span class="emblem-color2">║</span><span class="emblem-color1"> ▐█</span><span class="emblem-color2">░</span><span class="emblem-color1">┌─────────────────────────────────────┐</span><span class="emblem-color2">░</span><span class="emblem-color1">█▌ </span><span class="emblem-color2">║</span>
<span class="emblem-color2">║</span><span class="emblem-color1"> ▐█</span><span class="emblem-color2">░</span><span class="emblem-color1">│</span><span class="emblem-color2"> ▓▓▒▒░░ ＣＵＬＴＯＳ ＣＯＭＰＬＥＸ ░░▒▒▓▓ </span><span class="emblem-color1">│</span><span class="emblem-color2">░</span><span class="emblem-color1">█▌ </span><span class="emblem-color2">║</span>
<span class="emblem-color2">║</span><span class="emblem-color1"> ▐█</span><span class="emblem-color2">░</span><span class="emblem-color1">│</span><span class="emblem-color2"> ▓▒░ </span><span class="emblem-color4">╔═══╦═══╦═══╗ ╔═══╦═══╦═══╗</span><span class="emblem-color2"> ░▒▓ </span><span class="emblem-color1">│</span><span class="emblem-color2">░</span><span class="emblem-color1">█▌ </span><span class="emblem-color2">║</span>
<span class="emblem-color2">║</span><span class="emblem-color1"> ▐█</span><span class="emblem-color2">░</span><span class="emblem-color1">│</span><span class="emblem-color2"> ▒░  </span><span class="emblem-color4">║███║███║███║ ║▓▓▓║▓▓▓║▓▓▓║</span><span class="emblem-color2">  ░▒ </span><span class="emblem-color1">│</span><span class="emblem-color2">░</span><span class="emblem-color1">█▌ </span><span class="emblem-color2">║</span>
<span class="emblem-color2">║</span><span class="emblem-color1"> ▐█</span><span class="emblem-color2">░</span><span class="emblem-color1">│</span><span class="emblem-color2"> ░   </span><span class="emblem-color4">╚═══╩═══╩═══╝ ╚═══╩═══╩═══╝</span><span class="emblem-color2">   ░ </span><span class="emblem-color1">│</span><span class="emblem-color2">░</span><span class="emblem-color1">█▌ </span><span class="emblem-color2">║</span>
<span class="emblem-color2">║</span><span class="emblem-color1"> ▐█</span><span class="emblem-color2">░</span><span class="emblem-color1">└─────────────────────────────────────┘</span><span class="emblem-color2">░</span><span class="emblem-color1">█▌ </span><span class="emblem-color2">║</span>
<span class="emblem-color2">║</span><span class="emblem-color1"> ▐█</span><span class="emblem-color2">░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class="emblem-color1">█▌ </span><span class="emblem-color2">║</span>
<span class="emblem-color2">║</span><span class="emblem-color1"> ▐█▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█▌ </span><span class="emblem-color2">║</span>
<span class="emblem-color2">╚═══</span><span class="emblem-color1">╔═════════════════╗</span><span class="emblem-color2">░░░</span><span class="emblem-color1">╔═════════════════╗</span><span class="emblem-color2">═══╝</span>
<span class="emblem-color2">  ╔═╝</span><span class="emblem-color1">▒▒▒▒▒ ▒▒▒▒▒ ▒▒▒▒▒</span><span class="emblem-color2">░</span><span class="emblem-color1">█</span><span class="emblem-color2">░</span><span class="emblem-color1">▒▒▒▒▒ ▒▒▒▒▒ ▒▒▒▒▒</span><span class="emblem-color2">╚═╗</span>
<span class="emblem-color2"> ╔╝</span><span class="emblem-color1">┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐</span><span class="emblem-color2">╚╗</span>
<span class="emblem-color2">╔╝</span><span class="emblem-color1">│ </span><span class="emblem-color2">▓▓ </span><span class="emblem-color1">││ </span><span class="emblem-color2">▓▓ </span><span class="emblem-color1">││ </span><span class="emblem-color2">▓▓ </span><span class="emblem-color1">││ </span><span class="emblem-color2">▓▓ </span><span class="emblem-color1">││ </span><span class="emblem-color2">▓▓ </span><span class="emblem-color1">││ </span><span class="emblem-color2">▓▓ </span><span class="emblem-color1">││ </span><span class="emblem-color2">▓▓ </span><span class="emblem-color1">││ </span><span class="emblem-color2">▓▓ </span><span class="emblem-color1">│</span><span class="emblem-color2">╚╗</span>
<span class="emblem-color2">║</span><span class="emblem-color1">└───┘└───┘└───┘└───┘└───┘└───┘└───┘└───┘</span><span class="emblem-color2">║</span>
<span class="emblem-color2">║</span><span class="emblem-color1">┌─────┐┌─────┐┌─────┐┌─────┐┌─────┐┌─────┐</span><span class="emblem-color2">║</span>
<span class="emblem-color2">║</span><span class="emblem-color1">│ </span><span class="emblem-color2">░▒▓█ </span><span class="emblem-color1">││ </span><span class="emblem-color2">░▒▓█ </span><span class="emblem-color1">││ </span><span class="emblem-color2">░▒▓█ </span><span class="emblem-color1">││ </span><span class="emblem-color2">░▒▓█ </span><span class="emblem-color1">││ </span><span class="emblem-color2">░▒▓█ </span><span class="emblem-color1">││ </span><span class="emblem-color2">░▒▓█ </span><span class="emblem-color1">│</span><span class="emblem-color2">║</span>
<span class="emblem-color2">║</span><span class="emblem-color1">└─────┘└─────┘└─────┘└─────┘└─────┘└─────┘</span><span class="emblem-color2">║</span>
<span class="emblem-color2">╚════</span><span class="emblem-color1">▒▓█▓▒░</span><span class="emblem-color2">══════════════════════</span><span class="emblem-color1">░▒▓█▓▒</span><span class="emblem-color2">════╝</span>
<span class="emblem-color2">     ╚══╝ </span><span class="emblem-color1">▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ </span><span class="emblem-color2">╚══╝     </span>
`;
            }

            function adjustFontSize(element, maxSize, minSize) {
                let fontSize = maxSize;
                element.style.fontSize = fontSize + 'px';
                while (element.scrollWidth > element.offsetWidth && fontSize > minSize) {
                    fontSize--;
                    element.style.fontSize = fontSize + 'px';
                }
            }

            function generateEmblem() {
                const elderThingCount = gameState.monsters['Elder Thing'].count;
                const starSpawnCount = gameState.monsters['Star Spawn'].count;
                const hasCosmicInsight = gameState.upgrades.includes('Cosmic Insight');
                const hasDimensionalRift = gameState.upgrades.includes('Dimensional Rift');

                // 色の定義（進行状況に応じて変更）
                const colors = {
                    base1: getBaseColor1(),
                    base2: getBaseColor2(),
                    highlight1: getHighlightColor1(),
                    highlight2: getHighlightColor2()
                };

                let emblemLines = [
                    `<span style="color:${colors.base2}">   ╔════════════════════════════════════════════════════╗   </span>`,
                    `<span style="color:${colors.base2}"> ╔═╝</span><span style="color:${colors.base1}">  ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄  </span><span style="color:${colors.base2}">╚═╗ </span>`,
                    `<span style="color:${colors.base2}">╔╝</span><span style="color:${colors.base1}"> ▐█</span><span style="color:${colors.base2}">░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span style="color:${colors.base1}">█▌ </span><span style="color:${colors.base2}">╚╗</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}"> ▐█</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">┌─────────────────────────────────────┐</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">█▌ </span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}"> ▐█</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">│</span><span style="color:${colors.base2}"> ▓▓▒▒░░ ＣＵＬＴＯＳ ＣＯＭＰＬＥＸ ░░▒▒▓▓ </span><span style="color:${colors.base1}">│</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">█▌ </span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}"> ▐█</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">│</span><span style="color:${colors.base2}"> ▓▒░ </span><span style="color:${colors.highlight1}">╔${elderThingCount > 10 ? '═══' : '   '}╦${elderThingCount > 10 ? '═══' : '   '}╦${elderThingCount > 10 ? '═══' : '   '}╗ ╔${elderThingCount > 10 ? '═══' : '   '}╦${elderThingCount > 10 ? '═══' : '   '}╦${elderThingCount > 10 ? '═══' : '   '}╗</span><span style="color:${colors.base2}"> ░▒▓ </span><span style="color:${colors.base1}">│</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">█▌ </span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}"> ▐█</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">│</span><span style="color:${colors.base2}"> ▒░  </span><span style="color:${colors.highlight1}">║${hasCosmicInsight ? '███' : '▓▓▓'}║${hasCosmicInsight ? '███' : '▓▓▓'}║${hasCosmicInsight ? '███' : '▓▓▓'}║ ║${hasCosmicInsight ? '███' : '▓▓▓'}║${hasCosmicInsight ? '███' : '▓▓▓'}║${hasCosmicInsight ? '███' : '▓▓▓'}║</span><span style="color:${colors.base2}">  ░▒ </span><span style="color:${colors.base1}">│</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">█▌ </span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}"> ▐█</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">│</span><span style="color:${colors.base2}"> ░   </span><span style="color:${colors.highlight1}">╚${starSpawnCount > 5 ? '═★═' : '═══'}╩${starSpawnCount > 5 ? '═★═' : '═══'}╩${starSpawnCount > 5 ? '═★═' : '═══'}╝ ╚${starSpawnCount > 5 ? '═★═' : '═══'}╩${starSpawnCount > 5 ? '═★═' : '═══'}╩${starSpawnCount > 5 ? '═★═' : '═══'}╝</span><span style="color:${colors.base2}">   ░ </span><span style="color:${colors.base1}">│</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">█▌ </span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}"> ▐█</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">└─────────────────────────────────────┘</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">█▌ </span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}"> ▐█</span><span style="color:${colors.base2}">░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span style="color:${colors.base1}">█▌ </span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}"> ▐█▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█▌ </span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">╚═══</span><span style="color:${colors.base1}">╔═════════════════╗</span><span style="color:${colors.base2}">░░░</span><span style="color:${colors.base1}">╔═════════════════╗</span><span style="color:${colors.base2}">═══╝</span>`,
                    `<span style="color:${colors.base2}">  ╔═╝</span><span style="color:${colors.base1}">▒▒▒▒▒ ▒▒▒▒▒ ▒▒▒▒▒</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">█</span><span style="color:${colors.base2}">░</span><span style="color:${colors.base1}">▒▒▒▒▒ ▒▒▒▒▒ ▒▒▒▒▒</span><span style="color:${colors.base2}">╚═╗</span>`,
                    `<span style="color:${colors.base2}"> ╔╝</span><span style="color:${colors.base1}">${hasDimensionalRift ? '┌━━━┐┌━━━┐┌━━━┐┌━━━┐┌━━━┐┌━━━┐┌━━━┐┌━━━┐' : '┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐'}</span><span style="color:${colors.base2}">╚╗</span>`,
                    `<span style="color:${colors.base2}">╔╝</span><span style="color:${colors.base1}">│ </span><span style="color:${colors.highlight2}">▓▓ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">▓▓ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">▓▓ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">▓▓ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">▓▓ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">▓▓ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">▓▓ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">▓▓ </span><span style="color:${colors.base1}">│</span><span style="color:${colors.base2}">╚╗</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}">${hasDimensionalRift ? '└━━━┘└━━━┘└━━━┘└━━━┘└━━━┘└━━━┘└━━━┘└━━━┘' : '└───┘└───┘└───┘└───┘└───┘└───┘└───┘└───┘'}</span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}">┌─────┐┌─────┐┌─────┐┌─────┐┌─────┐┌─────┐</span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}">│ </span><span style="color:${colors.highlight2}">░▒▓█ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">░▒▓█ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">░▒▓█ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">░▒▓█ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">░▒▓█ </span><span style="color:${colors.base1}">││ </span><span style="color:${colors.highlight2}">░▒▓█ </span><span style="color:${colors.base1}">│</span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">║</span><span style="color:${colors.base1}">└─────┘└─────┘└─────┘└─────┘└─────┘└─────┘</span><span style="color:${colors.base2}">║</span>`,
                    `<span style="color:${colors.base2}">╚════</span><span style="color:${colors.base1}">▒▓█▓▒░</span><span style="color:${colors.base2}">══════════════════════</span><span style="color:${colors.base1}">░▒▓█▓▒</span><span style="color:${colors.base2}">════╝</span>`,
                    `<span style="color:${colors.base2}">     ╚══╝ </span><span style="color:${colors.base1}">▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ </span><span style="color:${colors.base2}">╚══╝     </span>`
                ];

                return emblemLines.join('\n');
            }

            function getBaseColor1() {
                const totalMonsters = Object.values(gameState.monsters).reduce((sum, monster) => sum + monster.count, 0);
                if (totalMonsters > 1000) return '#FF1493'; // ディープピンク
                if (totalMonsters > 500) return '#FF69B4'; // ホットピンク
                if (totalMonsters > 100) return '#FFB6C1'; // ライトピンク
                return '#1aff1a'; // デフォルトの緑色
            }

            function getBaseColor2() {
                const totalUpgrades = gameState.upgrades.length;
                if (totalUpgrades > 8) return '#4B0082'; // インディゴ
                if (totalUpgrades > 5) return '#8A2BE2'; // ブルーバイオレット
                if (totalUpgrades > 2) return '#9370DB'; // ミディアムパープル
                return '#118011'; // デフォルトの濃い緑色
            }

            function getHighlightColor1() {
                const elderThingCount = gameState.monsters['Elder Thing'].count;
                if (elderThingCount > 100) return '#FFD700'; // ゴールド
                if (elderThingCount > 50) return '#FFA500'; // オレンジ
                if (elderThingCount > 10) return '#FF8C00'; // ダークオレンジ
                return '#ffff1a'; // デフォルトの黄色
            }

            function getHighlightColor2() {
                const starSpawnCount = gameState.monsters['Star Spawn'].count;
                if (starSpawnCount > 50) return '#00FFFF'; // シアン
                if (starSpawnCount > 25) return '#00CED1'; // ダークターコイズ
                if (starSpawnCount > 5) return '#20B2AA'; // ライトシーグリーン
                return '#ff1a1a'; // デフォルトの赤色
            }

            function updateEmblem() {
                const emblem = document.getElementById('emblem');
                if (!emblem) {
                    console.error("Emblem element not found");
                    return;
                }

                const newEmblemContent = generateEmblem();
                if (emblem.innerHTML !== newEmblemContent) {
                    emblem.classList.add('emblem-flash');
                    emblem.innerHTML = newEmblemContent;
                    console.log("Emblem updated");
                    setTimeout(() => emblem.classList.remove('emblem-flash'), 1000);
                }
            }

            function jumpToSummonOldOne() {
                const summonOldOneSection = document.querySelector('.main-content');
                if (summonOldOneSection) {
                    summonOldOneSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setTimeout(() => {
                        window.scrollBy(0, -document.getElementById('game-header').offsetHeight);
                    }, 500);
                }
            }

            function setupTopButtons() {
                const jumpToSummonOldOneBtn = document.getElementById('jumpToSummonOldOne');
                if (jumpToSummonOldOneBtn) {
                    jumpToSummonOldOneBtn.addEventListener('click', jumpToSummonOldOne);
                }

                const jumpToMadnessTableBtn = document.getElementById('jumpToMadnessTable');
                if (jumpToMadnessTableBtn) {
                    jumpToMadnessTableBtn.addEventListener('click', jumpToMadnessTable);
                }

                const toggleAllCardsBtn = document.getElementById('toggleAllMonsterCards');
                if (toggleAllCardsBtn) {
                    toggleAllCardsBtn.addEventListener('click', () => {
                        const detailDivs = document.querySelectorAll('.monster-card-details');
                        const isExpanded = !detailDivs[0].classList.contains('expanded');
                        toggleMonsterCardDetails(isExpanded);
                    });
                }

                // Back to Top button functionality is already handled by the existing code
            }

            // スクロールイベントリスナー
            window.addEventListener('scroll', function () {
                const backToTopBtn = document.getElementById('backToTopBtn');
                if (backToTopBtn) {
                    if (window.pageYOffset > 300) { // 300pxスクロールしたら表示
                        backToTopBtn.style.display = 'block';
                    } else {
                        backToTopBtn.style.display = 'none';
                    }
                }
            });

            function updateUpgradeSymbols() {
                const symbolsContainer = document.getElementById('upgradeSymbols');
                if (!symbolsContainer) {
                    console.error('Upgrade symbols container not found');
                    return;
                }

                symbolsContainer.innerHTML = '';

                for (let upgrade of gameState.upgrades) {
                    if (upgradeSymbols[upgrade]) {
                        const symbol = document.createElement('span');
                        symbol.className = 'upgrade-symbol';
                        symbol.innerHTML = `
                ${upgradeSymbols[upgrade]}
                <span class="tooltip">${upgrade}: ${upgradeEffects[upgrade]}</span>
            `;
                        symbolsContainer.appendChild(symbol);
                    }
                }
            }

            function toggleTimeAcceleration() {
                const accelerationLevels = [1, 2, 5, 10, 50, 100];
                const currentIndex = accelerationLevels.indexOf(timeAcceleration);
                const nextIndex = (currentIndex + 1) % accelerationLevels.length;
                timeAcceleration = accelerationLevels[nextIndex];
                updateTimeAccelerationDisplay();
            }

            function toggleMonsterCardDetails(expanded) {
                const monsterCards = document.querySelectorAll('.monster-card-details');
                const tooltips = document.querySelectorAll('.monster-card-header .tooltip');

                monsterCards.forEach(card => {
                    card.classList.toggle('expanded', expanded);
                });

                tooltips.forEach(tooltip => {
                    tooltip.style.display = expanded ? 'none' : 'block';
                });

                const toggleAllBtn = document.getElementById('toggleAllMonsterCards');
                if (toggleAllBtn) {
                    toggleAllBtn.textContent = expanded ? 'Collapse All Cards' : 'Expand All Cards';
                }

                localStorage.setItem('monsterCardsExpanded', expanded);
            }

            function jumpToMadnessTable() {
                const madnessTable = document.getElementById('madnessTable');
                if (madnessTable) {
                    madnessTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setTimeout(() => {
                        window.scrollBy(0, -60);  // トップボタンの高さ分だけ上にスクロール
                    }, 500);  // スクロールアニメーションが終わった後に実行
                }
            }

            function restoreMonsterCardState() {
                const isExpanded = localStorage.getItem('monsterCardsExpanded') === 'true';
                const monsterCards = document.querySelectorAll('.monster-card-details');
                const toggleBtns = document.querySelectorAll('.toggle-details');

                monsterCards.forEach(card => {
                    card.classList.toggle('expanded', isExpanded);
                });

                toggleBtns.forEach(btn => {
                    btn.textContent = isExpanded ? '▲' : '▼';
                });
            }

            function updateTimeAccelerationDisplay() {
                const display = document.getElementById('timeAccelerationDisplay');
                display.textContent = `x${timeAcceleration}`;
            }

            document.getElementById('toggleTimeAcceleration').addEventListener('click', toggleTimeAcceleration);

            // Update getCost function
            function getCost(item) {
                if (typeof item !== 'string') {
                    console.error(`Invalid item type passed to getCost: ${typeof item}`);
                    return Infinity;
                }
                const count = item === 'follower' ? gameState.followers : (gameState.monsters[item]?.count || 0);
                const baseCost = baseCosts[item];
                if (typeof baseCost !== 'number' || isNaN(baseCost)) {
                    console.error(`Invalid base cost for ${item}: ${baseCost}`);
                    return Infinity;
                }
                const inflatedCost = Math.floor(baseCost * Math.pow(1.25, count));
                const multiplier = gameState.upgradeCostMultiplier || 1;
                const finalCost = Math.floor(inflatedCost * multiplier);
                if (!isFinite(finalCost)) {
                    console.error(`Invalid cost calculated for ${item}: ${finalCost}`);
                    return Infinity;
                }
                return finalCost;
            }

            // Collect source function
            function collectSource() {
                gameState.source += 1; // 1回のクリックで1つだけ増加
                logAction("Collected 1 source");
            }

            // デバッグ用の関数を追加
            function debug(message) {
                console.log(`[DEBUG] ${message}`);
            }

            // 各主要関数にデバッグログを追加

            async function executeAction(action, params = {}) {
                debug(`executeAction called with action: ${action.name}`);
                if (globalLock) {
                    debug("Global lock is active, action not executed");
                    return;
                }
                globalLock = true;

                try {
                    if (action === summonMonster) {
                        await action(params.type);  // パラメータからタイプを取り出す
                    } else {
                        await action(params);
                    }
                    debug(`Action ${action.name} executed successfully`);
                } catch (error) {
                    debug(`Error executing action ${action.name}: ${error}`);
                } finally {
                    globalLock = false;
                }
            }

            function recruitFollower() {
                console.log("recruitFollower function called");
                const cost = getCost('follower');

                if (gameState.source >= cost) {
                    gameState.source -= cost;
                    gameState.followers++;

                    logAction(`Recruited 1 follower for ${cost} source`);
                    console.log(`Follower recruited. New count: ${gameState.followers}`);
                } else {
                    console.log(`Not enough source to recruit follower. Required: ${cost}, Available: ${gameState.source}`);
                }
                updateEmblem();
            }

            // summonMonster関数を非同期に変更
            function summonMonster(type) {
                if (globalLock) return;
                globalLock = true;

                try {
                    debug(`summonMonster called for ${type}`);
                    if (!gameState.monsters[type]) {
                        debug(`Invalid monster type: ${type}`);
                        return;
                    }
                    const sourceCost = getCost(type);
                    const monsterData = gameState.monsters[type];
                    const followerCost = Math.floor(monsterData.baseFollowerCost * Math.pow(monsterData.followerCostGrowth, monsterData.count));

                    if (gameState.source >= sourceCost && gameState.followers >= followerCost) {
                        gameState.source -= sourceCost;
                        gameState.followers -= followerCost;
                        monsterData.count++;
                        logAction(`Summoned 1 ${type} for ${formatNumber(sourceCost)} source and ${formatNumber(followerCost)} followers`);
                        debug(`Monster summoned. New count: ${monsterData.count}`);

                        // ASCII アートをフラッシュ
                        const monsterCards = document.querySelectorAll('.monster-card');
                        monsterCards.forEach(card => {
                            if (card.querySelector('h3').textContent.includes(type)) {
                                const asciiArt = card.querySelector('.ascii-art');
                                if (asciiArt) {
                                    asciiArt.classList.add('white-flash');
                                    setTimeout(() => asciiArt.classList.remove('white-flash'), 500);
                                }
                            }
                        });

                        updateEmblem();
                    } else {
                        if (gameState.source < sourceCost) {
                            debug(`Not enough source to summon ${type}. Required: ${sourceCost}, Available: ${gameState.source}`);
                        }
                        if (gameState.followers < followerCost) {
                            debug(`Not enough followers to summon ${type}. Required: ${followerCost}, Available: ${gameState.followers}`);
                        }
                    }
                } finally {
                    globalLock = false;
                }
            }

            function buyUpgrade(upgrade) {
                debug(`buyUpgrade called for ${upgrade}`);
                const cost = Math.floor(baseCosts[upgrade] * (gameState.upgradeCostMultiplier || 1));
                if (gameState.source >= cost && !gameState.upgrades.includes(upgrade)) {
                    gameState.source -= cost;
                    gameState.upgrades.push(upgrade);
                    applyUpgrade(upgrade);
                    updateUpgradeSymbols();
                    updateUpgradeGrid();  // アップグレードグリッドを更新
                    updateDisplay();  // 全体の表示を更新
                    logAction(`Bought ${upgrade} upgrade for ${formatNumber(cost)} source`);
                    debug(`Upgrade bought. New upgrades: ${gameState.upgrades}`);
                } else {
                    if (gameState.source < cost) {
                        logAction(`Not enough source to buy ${upgrade}. Need ${formatNumber(cost)}, have ${formatNumber(gameState.source)}`);
                    } else {
                        logAction(`${upgrade} has already been purchased`);
                    }
                    debug(`Unable to buy upgrade ${upgrade}. Cost: ${cost}, Available: ${gameState.source}, Already owned: ${gameState.upgrades.includes(upgrade)}`);
                }
            }

            function calculateTimeToSummon(sourceDifference, productionPerSecond) {
                if (productionPerSecond <= 0) {
                    return sourceDifference > 0 ? Infinity : 0;
                }
                return Math.max(0, sourceDifference / productionPerSecond);
            }

            function calculateSynergyEffects() {
                let synergyEffects = {};
                for (let monster in gameState.monsters) {
                    const monsterData = gameState.monsters[monster];
                    if (monsterData.synergy && gameState.monsters[monsterData.synergy.partner].count > 0) {
                        synergyEffects[monster] = {
                            effect: monsterData.synergy.effect,
                            type: monsterData.synergy.type || 'all'
                        };
                        synergyEffects[monsterData.synergy.partner] = {
                            effect: monsterData.synergy.effect,
                            type: monsterData.synergy.type || 'all'
                        };
                    }
                }
                return synergyEffects;
            }

            function applySpecialAbilities() {
                for (let monster in gameState.monsters) {
                    const monsterData = gameState.monsters[monster];
                    if (monsterData.specialAbility) {
                        const triggerCount = Math.floor(monsterData.count / monsterData.specialAbility.trigger);
                        if (triggerCount > 0) {
                            applySpecialAbilityEffect(monster, triggerCount);
                        }
                    }
                }
            }

            function applySpecialAbilityEffect(monsterType, effectType, value) {
                const monster = gameState.monsters[monsterType];
                if (!monster || !monster.specialAbility || monster.specialAbility.effect.type !== effectType) {
                    return value;  // 効果が適用できない場合は元の値を返す
                }

                const triggerCount = Math.floor(monster.count / monster.specialAbility.trigger);
                if (triggerCount === 0) {
                    return value;  // トリガー条件を満たしていない場合は元の値を返す
                }

                switch (effectType) {
                    case 'allMonsterEfficiency':
                        return value * Math.pow(1 + monster.specialAbility.effect.value, triggerCount);
                    case 'followerEfficiencyMultiplier':
                        return value * Math.pow(1 + monster.specialAbility.effect.value, monster.count);
                    case 'followerEfficiency':
                        return value * Math.pow(1 + monster.specialAbility.effect.value, triggerCount);
                    case 'sourceProduction':
                        return value * Math.pow(1 + monster.specialAbility.effect.value, triggerCount);
                    case 'upgradeEffect':
                        return value * Math.pow(1 + monster.specialAbility.effect.value, triggerCount);
                    case 'followerProduction':
                        return value + monster.specialAbility.effect.value * triggerCount;
                    case 'cosmicResonance':
                        return value * Math.pow(1 + monster.specialAbility.effect.value, triggerCount);
                    case 'upgradeCost':
                        const totalDiscount = Math.min(monster.specialAbility.effect.maxDiscount, monster.specialAbility.effect.value * triggerCount);
                        return value * (1 - totalDiscount);
                    case 'adventurerResistanceRecoveryTime':
                        return value - (monster.specialAbility.effect.value * triggerCount);
                    case 'miasmaEfficiency':
                        return value * Math.pow(1 + monster.specialAbility.effect.value, triggerCount);
                    default:
                        return value;
                }
            }

            // Update upgrade effects
            function applyUpgrade(upgrade, multiplier = 1) {
                switch (upgrade) {
                    case "Ritual Knowledge":
                        gameState.followerEfficiency *= (1 + 0.25 * multiplier);
                        break;
                    case "Eldritch Tome":
                        for (let monster in gameState.monsters) {
                            gameState.monsters[monster].sourceEfficiency *= (1 + 0.25 * multiplier);
                            gameState.monsters[monster].miasmaEfficiency *= (1 + 0.25 * multiplier);
                        }
                        break;
                    case "Cosmic Alignment":
                        gameState.cosmicAlignmentBonus = 1 + (0.1 * multiplier);
                        break;
                    case "Dark Pact":
                        for (let monster in gameState.monsters) {
                            gameState.monsters[monster].sourceEfficiency *= (1 + 0.4 * multiplier);
                        }
                        break;
                    case "Hermes Trismegistus' Teachings":
                        gameState.followerEfficiency *= (1 + 0.3 * multiplier);
                        break;
                    case "Cosmic Insight":
                        gameState.followerEfficiency *= (1 + 0.35 * multiplier);
                        for (let monster in gameState.monsters) {
                            gameState.monsters[monster].sourceEfficiency *= (1 + 0.35 * multiplier);
                            gameState.monsters[monster].miasmaEfficiency *= (1 + 0.35 * multiplier);
                        }
                        break;
                    case "Astral Projection":
                        gameState.astralProjectionRate = 0.03 * multiplier;
                        break;
                    case "Necronomicon Fragment":
                        for (let monster in gameState.monsters) {
                            gameState.monsters[monster].sourceEfficiency *= (1 + 0.5 * multiplier);
                            gameState.monsters[monster].miasmaEfficiency *= (1 + 0.5 * multiplier);
                        }
                        break;
                    case "Psychic Attunement":
                        for (let monster in gameState.monsters) {
                            gameState.monsters[monster].miasmaEfficiency *= (1 + 0.3 * multiplier);
                        }
                        break;
                    case "Quantum Entanglement":
                        gameState.quantumEntanglementBonus = 0.05 * multiplier;
                        break;
                    case "Temporal Manipulation":
                        gameState.temporalManipulationBonus = 1 + (0.2 * multiplier);
                        break;
                    case "Eldritch Evolution":
                        gameState.eldritchEvolutionRate = 0.001 * multiplier;
                        break;
                    case "Dimensional Rift":
                        for (let upgrade of gameState.upgrades) {
                            if (upgrade !== "Dimensional Rift") {
                                applyUpgrade(upgrade, 1 + 0.5 * multiplier);
                            }
                        }
                        break;
                }
            }

            // Optimized update upgrade grid
            function updateUpgradeGrid() {
                const grid = document.getElementById('upgradeGrid');
                const sourceCount = Math.floor(gameState.source);
                const upgrades = Object.keys(upgradeEffects);

                for (let upgrade of upgrades) {
                    if (gameState.upgrades.includes(upgrade)) {
                        const existingCard = document.getElementById(`upgrade-${upgrade}`);
                        if (existingCard) {
                            existingCard.remove();
                        }
                        continue;
                    }

                    let card = document.getElementById(`upgrade-${upgrade}`);
                    if (!card) {
                        card = document.createElement('div');
                        card.id = `upgrade-${upgrade}`;
                        card.className = 'upgrade-card';
                        card.innerHTML = `
                <h3>${upgradeSymbols[upgrade]} ${upgrade}</h3>
                <p>${upgradeEffects[upgrade]}</p>
                <button class="buy-upgrade-btn" data-upgrade="${upgrade}">Buy</button>
            `;
                        grid.appendChild(card);
                    }

                    const buyBtn = card.querySelector('.buy-upgrade-btn');
                    const cost = getCost(upgrade);
                    buyBtn.textContent = `Buy (${formatNumber(cost)} source)`;
                    buyBtn.disabled = sourceCount < cost;
                    buyBtn.classList.toggle('button-enabled', sourceCount >= cost);
                    buyBtn.classList.toggle('button-disabled', sourceCount < cost);
                }
            }

            function updateAdventurerStates() {
                const currentTime = Date.now();
                gameState.adventurers.forEach(adventurer => {
                    if (adventurer.cooldownEndTime <= currentTime) {
                        if (adventurer.isMad) {
                            adventurer.isMad = false;
                            logAction(`${adventurer.name} has returned to sanity and can be challenged again!`);
                        }
                        adventurer.cooldownEndTime = 0;
                    }
                });
            }

            // updateMadnessTable関数を修正
            function updateMadnessTable() {
                const adventurersContainer = document.getElementById('adventurers');
                if (!adventurersContainer) {
                    console.error("Adventurers container not found");
                    return;
                }

                const currentTime = Date.now();
                const miasmaCount = Math.floor(gameState.miasma);

                gameState.adventurers.forEach((adventurer, index) => {
                    let adventurerElement = document.getElementById(`adventurer-${index}`);
                    if (!adventurerElement) {
                        adventurerElement = document.createElement('div');
                        adventurerElement.id = `adventurer-${index}`;
                        adventurerElement.className = 'adventurer';
                        adventurerElement.innerHTML = `
                <h3>${adventurer.name}</h3>
                <div class="ascii-art">${asciiArt[adventurer.name]}</div>
                <p>Level: <span class="adventurer-level"></span></p>
                <p>Miasma Required: <span class="miasma-required"></span></p>
                <p>Follower Production: <span class="follower-production"></span>/sec</p>
                <p>Madness Chance: <span class="madness-chance"></span>%</p>
                <p>Status: <span class="adventurer-status"></span></p>
                <button class="madness-btn" data-index="${index}">Attempt Madness</button>
                <p>Cooldown: <span class="cooldown-status"></span></p>
            `;
                        adventurersContainer.appendChild(adventurerElement);
                    }

                    const currentTime = Date.now();
                    const cooldownRemaining = Math.max(0, adventurer.cooldownEndTime - currentTime);
                    const isReady = cooldownRemaining === 0;
                    // 各要素の更新
                    updateElementText(adventurerElement, '.adventurer-level', adventurer.level);
                    updateElementText(adventurerElement, '.miasma-required', formatNumber(Math.floor(adventurer.miasmaRequired)));
                    updateElementText(adventurerElement, '.follower-production', formatNumber(adventurer.followerProduction, 1));
                    updateElementText(adventurerElement, '.madness-chance', (adventurer.madnessChance * 100).toFixed(0));
                    updateElementText(adventurerElement, '.adventurer-status', adventurer.isMad ? 'Mad' : (isReady ? 'Ready' : 'Cooldown'));

                    // クールダウンの表示を更新
                    let cooldownText = isReady ? 'Ready' : `Cooldown: ${formatTime(cooldownRemaining / 1000)}`;
                    updateElementText(adventurerElement, '.cooldown-status', cooldownText);

                    // ボタンの状態を更新
                    const madnessBtn = adventurerElement.querySelector('.madness-btn');
                    if (madnessBtn) {
                        const canAttemptMadness = miasmaCount >= adventurer.miasmaRequired && isReady;
                        madnessBtn.disabled = !canAttemptMadness;
                        madnessBtn.classList.toggle('button-enabled', canAttemptMadness);
                        madnessBtn.classList.toggle('button-disabled', !canAttemptMadness);
                    }


                    if (adventurerElement) {
                        const adventurerAscii = adventurerElement.querySelector('.ascii-art');
                        if (adventurerAscii) {
                            if (adventurer.isMad && adventurer.cooldownEndTime > currentTime) {
                                adventurerAscii.classList.add('red-filter');
                            } else {
                                adventurerAscii.classList.remove('red-filter');
                            }
                        }
                    }
                });
            }

            // ヘルパー関数：要素のテキストを安全に更新
            function updateElementText(parentElement, selector, text) {
                const element = parentElement.querySelector(selector);
                if (element) {
                    element.textContent = text;
                } else {
                    console.warn(`Element not found: ${selector}`);
                }
            }

            // attemptMadness関数を修正
            function attemptMadness(index) {
                const adventurer = gameState.adventurers[index];
                const currentTime = Date.now();

                if (gameState.miasma < adventurer.miasmaRequired || adventurer.cooldownEndTime > currentTime) {
                    console.log(`Cannot attempt madness. Miasma: ${gameState.miasma}, Required: ${adventurer.miasmaRequired}, Cooldown: ${adventurer.cooldownEndTime - currentTime}ms`);
                    return;
                }

                gameState.miasma -= adventurer.miasmaRequired;

                if (Math.random() < adventurer.madnessChance) {
                    adventurer.isMad = true;
                    adventurer.level++;
                    // Calculate new follower production based on base production and level
                    adventurer.followerProduction = adventurer.followerProduction * 1.5;
                    adventurer.miasmaRequired *= 1.5;
                    adventurer.madnessChance *= 0.9;

                    const followerReward = Math.floor(adventurer.followerReward * Math.sqrt(adventurer.level));
                    gameState.followers += followerReward;

                    logAction(`${adventurer.name} went mad! Level up to ${adventurer.level}. Generating ${formatNumber(adventurer.followerProduction, 1)} followers/sec. Gained ${formatNumber(followerReward)} followers.`);
                    adventurer.cooldownEndTime = Date.now() + adventurer.baseCooldown;
                } else {
                    // 狂気に抵抗した場合
                    logAction(`${adventurer.name} resisted the madness.`);

                    let resistanceCooldown = Math.max(500, adventurer.baseCooldown / 2);
                    for (let monsterType in gameState.monsters) {
                        resistanceCooldown = applySpecialAbilityEffect(monsterType, 'adventurerResistanceRecoveryTime', resistanceCooldown);
                    }
                    resistanceCooldown = Math.max(500, resistanceCooldown);  // Minimum cooldown of 500ms

                    adventurer.cooldownEndTime = currentTime + resistanceCooldown;
                    console.log(`Resistance cooldown set for ${adventurer.name}: ${resistanceCooldown}ms, ends at ${new Date(adventurer.cooldownEndTime)}`);
                }

                // ASCII アートをフラッシュし、その後フィルターを適用
                const adventurerElement = document.querySelector(`#adventurer-${index}`);
                if (adventurerElement) {
                    const adventurerAscii = adventurerElement.querySelector('.ascii-art');
                    if (adventurerAscii) {
                        adventurerAscii.classList.add('white-flash');
                        setTimeout(() => {
                            adventurerAscii.classList.remove('white-flash');
                            adventurerAscii.classList.add('red-filter');
                        }, 500);
                    }
                }

                updateMadnessTable();
            }

            function handleMadnessAttempt(event) {
                if (event.target.classList.contains('madness-btn') && !event.target.disabled) {
                    const index = parseInt(event.target.dataset.index);
                    const adventurer = gameState.adventurers[index];
                    const currentTime = Date.now();

                    if (gameState.miasma >= adventurer.miasmaRequired && adventurer.cooldownEndTime <= currentTime) {
                        attemptMadness(index);
                    } else {
                        console.log(`Madness attempt prevented. Miasma: ${gameState.miasma}, Required: ${adventurer.miasmaRequired}, Cooldown: ${adventurer.cooldownEndTime - currentTime}ms`);
                    }
                    event.preventDefault();
                }
            }

            // イベントリスナーの設定
            const adventurersContainer = document.getElementById('adventurers');
            if (adventurersContainer) {
                adventurersContainer.addEventListener('click', handleMadnessAttempt);
            }

            function calculateResourceProduction() {
                let sourceProduction = gameState.followers * gameState.followerEfficiency;
                let miasmaProduction = 0;
                let followerProduction = 0;

                const synergyEffects = calculateSynergyEffects();

                for (let monster in gameState.monsters) {
                    const monsterData = gameState.monsters[monster];
                    const synergyEffect = synergyEffects[monster] || { effect: 0, type: 'all' };
                    const evolutionBonus = 1 + (Math.floor(monsterData.count / 10) * gameState.eldritchEvolutionRate);

                    let sourceMultiplier = (1 + (synergyEffect.type === 'all' || synergyEffect.type === 'source' ? synergyEffect.effect : 0)) * evolutionBonus;
                    let miasmaMultiplier = (1 + (synergyEffect.type === 'all' || synergyEffect.type === 'miasma' ? synergyEffect.effect : 0)) * evolutionBonus;

                    sourceProduction += monsterData.count * monsterData.sourceEfficiency * sourceMultiplier;
                    miasmaProduction += monsterData.count * monsterData.miasmaEfficiency * miasmaMultiplier;

                    // Apply Quantum Entanglement bonus
                    sourceProduction *= (1 + gameState.quantumEntanglementBonus);
                    miasmaProduction *= (1 + gameState.quantumEntanglementBonus);
                }

                for (let adventurer of gameState.adventurers) {
                    if (adventurer.isMad) {
                        followerProduction += adventurer.followerProduction;
                        console.log(`Mad adventurer ${adventurer.name} producing ${adventurer.followerProduction} followers/sec`);
                    }
                }
                console.log(`Total follower production from mad adventurers: ${followerProduction}`);

                // Apply Cosmic Alignment bonus
                if (Math.abs(gameState.followers - Object.values(gameState.monsters).reduce((sum, m) => sum + m.count, 0)) <= 10) {
                    sourceProduction *= gameState.cosmicAlignmentBonus;
                    miasmaProduction *= gameState.cosmicAlignmentBonus;
                }

                // Apply Temporal Manipulation bonus
                sourceProduction *= gameState.temporalManipulationBonus;
                miasmaProduction *= gameState.temporalManipulationBonus;

                // Apply Astral Projection
                sourceProduction += gameState.source * gameState.astralProjectionRate;

                return { sourceProduction, miasmaProduction, followerProduction };
            }



            function updateDisplay() {
                updateResourceDisplay();
                updateFollowerSection();
                if (document.getElementById('monsterGridContainer') && document.getElementById('monsterGrid')) {
                    updateMonsterGrid();
                } else {
                    console.error("Required elements for updateMonsterGrid not found");
                }
                updateUpgradeGrid();
                updateGameDetails();
                updateMadnessTable();
            }

            // updateGameDetails 関数の追加
            function updateGameDetails() {
                const detailsDiv = document.getElementById('gameDetails');
                if (!detailsDiv) {
                    console.warn("Game details div not found");
                    return;
                }

                const followerBoost = 1 + (gameState.followers * 0.01);
                const monsterTypes = Object.values(gameState.monsters).filter(m => m.count > 0).length;
                const monsterSynergyBoost = 1 + (monsterTypes * 0.1);

                let detailsHTML = `
        <p><strong>Follower Efficiency:</strong> ${formatNumber(gameState.followerEfficiency, 2)}</p>
        <p><strong>Follower Boost:</strong> ${formatNumber(followerBoost, 2)}x</p>
        <p><strong>Monster Synergy Boost:</strong> ${formatNumber(monsterSynergyBoost, 2)}x</p>
        <p><strong>Cosmic Alignment Bonus:</strong> ${formatNumber(gameState.cosmicAlignmentBonus, 2)}x</p>
        <p><strong>Astral Projection Rate:</strong> ${formatNumber(gameState.astralProjectionRate * 100, 2)}%</p>
        <p><strong>Quantum Entanglement Bonus:</strong> ${formatNumber(gameState.quantumEntanglementBonus * 100, 2)}%</p>
        <p><strong>Temporal Manipulation Bonus:</strong> ${formatNumber(gameState.temporalManipulationBonus, 2)}x</p>
        <p><strong>Eldritch Evolution Rate:</strong> ${formatNumber(gameState.eldritchEvolutionRate * 100, 2)}%</p>
        <p><strong>Active Upgrades:</strong> ${gameState.upgrades.join(', ') || 'None'}</p>
        <h3>Monster Production:</h3>
    `;

                for (let monster in gameState.monsters) {
                    if (gameState.monsters[monster].count > 0) {
                        const production = gameState.monsters[monster].count * gameState.monsters[monster].sourceEfficiency * followerBoost * monsterSynergyBoost;
                        detailsHTML += `<p>${monster}: ${formatNumber(production, 1)} source/sec</p>`;
                    }
                }

                detailsDiv.innerHTML = detailsHTML;
            }

            function updateResourceDisplay() {
                const sourceCount = Math.floor(gameState.source);
                const miasmaCount = Math.floor(gameState.miasma);
                const { sourceProduction, miasmaProduction } = calculateResourceProduction();

                document.getElementById('largeSourceCount').textContent = formatNumber(sourceCount, 0);
                document.getElementById('largeSourcePerSecond').textContent = formatNumber(sourceProduction, 1);
                document.getElementById('largeMiasmaCount').textContent = formatNumber(miasmaCount, 0);
                document.getElementById('largeMiasmaPerSecond').textContent = formatNumber(miasmaProduction, 1);

                const sourceElement = document.getElementById('largeSourceCount');
                const miasmaElement = document.getElementById('largeMiasmaCount');

                sourceElement.textContent = formatNumber(sourceCount, 3);
                miasmaElement.textContent = formatNumber(miasmaCount, 3);

                adjustFontSize(sourceElement, 32, 16);
                adjustFontSize(miasmaElement, 32, 16);

                // フォロワー召喚ボタンの更新（この部分は変更なし）
                const recruitFollowerBtn = document.getElementById('recruitFollowerBtn');
                const newFollowerCost = getCost('follower');
                recruitFollowerBtn.textContent = `Recruit Follower`;
                recruitFollowerBtn.disabled = sourceCount < newFollowerCost;
                recruitFollowerBtn.classList.toggle('button-enabled', sourceCount >= newFollowerCost);
                recruitFollowerBtn.classList.toggle('button-disabled', sourceCount < newFollowerCost);
            }

            function updateMonsterGrid() {
                const grid = document.getElementById('monsterGrid');
                if (!grid) {
                    console.error("Monster grid not found");
                    return;
                }

                const sourceCount = Math.floor(gameState.source);
                const followerCount = gameState.followers;

                for (let monster of monsterOrder) {
                    let card = document.getElementById(`monster-${monster}`);
                    if (!card) {
                        card = document.createElement('div');
                        card.id = `monster-${monster}`;
                        card.className = 'monster-card';
                        card.innerHTML = `
                <div class="monster-card-header">
                    <h3>${monster} (<span class="header-count">0</span>)</h3>
                    <div class="tooltip" style="display: block;">
                        <p>Source Efficiency: <span class="header-source-efficiency">0</span></p>
                        <p>Miasma Efficiency: <span class="header-miasma-efficiency">0</span></p>
                        <p>Total Source Production: <span class="header-source-production">0</span>/sec</p>
                        <p>Total Miasma Production: <span class="header-miasma-production">0</span>/sec</p>
                        <p>Next Summon Cost: <span class="header-next-cost">0</span> source, <span class="header-follower-cost">0</span> followers</p>
                    </div>
                </div>
                <div class="summon-progress-bar">
                    <div class="resource-progress source-progress"></div>
                    <div class="resource-progress follower-progress"></div>
                </div>
                <div class="monster-card-details">
                    <div class="ascii-art">${asciiArt[monster]}</div>
                    <p>Count: <span class="monster-count"></span></p>
                    <p>Source Efficiency: <span class="monster-source-efficiency"></span></p>
                    <p>Miasma Efficiency: <span class="monster-miasma-efficiency"></span></p>
                    <div class="monster-details">
                        <p>Total Source Production: <span class="monster-source-production"></span>/sec</p>
                        <p>Total Miasma Production: <span class="monster-miasma-production"></span>/sec</p>
                        <p>Next Summon Cost: <span class="monster-next-cost"></span> source and <span class="monster-follower-cost"></span> followers</p>
                        <p>Time to Next Summon: <span class="monster-time-to-summon"></span></p>
                        <p>Synergy: <span class="monster-synergy"></span></p>
                        <p>Special Ability: <span class="monster-special-ability"></span></p>
                    </div>
                </div>
                <button class="summon-monster-btn" data-monster="${monster}">Summon ${monster}</button>
            `;
                        grid.appendChild(card);
                        const summonBtn = card.querySelector('.summon-monster-btn');
                        summonBtn.addEventListener('click', () => summonMonster(monster));
                    }

                    const monsterData = gameState.monsters[monster];
                    if (!monsterData) {
                        console.error(`No data found for monster: ${monster}`);
                        continue;
                    }

                    const count = Math.floor(monsterData.count || 0);
                    const sourceEfficiency = monsterData.sourceEfficiency || 0;
                    const miasmaEfficiency = monsterData.miasmaEfficiency || 0;
                    const sourceProduction = count * sourceEfficiency;
                    const miasmaProduction = count * miasmaEfficiency;
                    const nextCost = getCost(monster);
                    const followerCost = Math.floor(monsterData.baseFollowerCost * Math.pow(monsterData.followerCostGrowth, count));
                    const sourceDifference = nextCost - sourceCount;
                    const { sourceProduction: currentSourceProduction } = calculateResourceProduction();
                    const timeToSummon = calculateTimeToSummon(sourceDifference, currentSourceProduction);

                    // プログレスバーの更新
                    const progressBar = card.querySelector('.summon-progress-bar');
                    if (progressBar) {
                        const sourceProgressEl = progressBar.querySelector('.source-progress');
                        const followerProgressEl = progressBar.querySelector('.follower-progress');

                        if (sourceProgressEl && followerProgressEl) {
                            const sourceProgress = Math.min(100, (sourceCount / nextCost) * 100);
                            const followerProgress = Math.min(100, (followerCount / followerCost) * 100);

                            sourceProgressEl.style.width = `${sourceProgress}%`;
                            followerProgressEl.style.width = `${followerProgress}%`;

                            sourceProgressEl.style.opacity = sourceProgress === 100 ? '0.8' : '0.5';
                            followerProgressEl.style.opacity = followerProgress === 100 ? '0.8' : '0.5';
                        }
                    }

                    // 各要素の更新
                    card.querySelector('.monster-count').textContent = formatNumber(count, 0);
                    card.querySelector('.monster-source-efficiency').textContent = formatNumber(sourceEfficiency, 2);
                    card.querySelector('.monster-miasma-efficiency').textContent = formatNumber(miasmaEfficiency, 2);
                    card.querySelector('.monster-source-production').textContent = formatNumber(sourceProduction, 0);
                    card.querySelector('.monster-miasma-production').textContent = formatNumber(miasmaProduction, 0);
                    card.querySelector('.monster-next-cost').textContent = formatNumber(nextCost, 0);
                    card.querySelector('.monster-follower-cost').textContent = formatNumber(followerCost, 0);
                    card.querySelector('.monster-time-to-summon').textContent = formatTime(timeToSummon);
                    card.querySelector('.header-count').textContent = formatNumber(count, 0);
                    card.querySelector('.header-source-efficiency').textContent = formatNumber(sourceEfficiency, 2);
                    card.querySelector('.header-miasma-efficiency').textContent = formatNumber(miasmaEfficiency, 2);
                    card.querySelector('.header-source-production').textContent = formatNumber(sourceProduction, 0);
                    card.querySelector('.header-miasma-production').textContent = formatNumber(miasmaProduction, 0);
                    card.querySelector('.header-next-cost').textContent = formatNumber(nextCost, 0);
                    card.querySelector('.header-follower-cost').textContent = formatNumber(followerCost, 0);

                    // シナジー情報の更新
                    const synergyInfo = monsterData.synergy;
                    const synergyElement = card.querySelector('.monster-synergy');
                    if (synergyInfo && synergyElement) {
                        let synergyText = `+${(synergyInfo.effect * 100).toFixed(1)}% `;
                        if (synergyInfo.type) {
                            synergyText += `${synergyInfo.type} `;
                        }
                        synergyText += `production with ${synergyInfo.partner}`;
                        synergyElement.textContent = synergyText;
                    }

                    // 特殊能力の更新
                    const specialAbilityInfo = monsterData.specialAbility;
                    const specialAbilityElement = card.querySelector('.monster-special-ability');
                    if (specialAbilityInfo && specialAbilityElement) {
                        const effect = specialAbilityInfo.effect;
                        let description = `Every ${specialAbilityInfo.trigger}: `;
                        description += describeSpecialAbility(effect);
                        specialAbilityElement.textContent = description;
                    }

                    // サモンボタンの更新
                    const summonBtn = card.querySelector('.summon-monster-btn');
                    if (summonBtn) {
                        summonBtn.disabled = sourceCount < nextCost || followerCount < followerCost;
                        summonBtn.classList.toggle('button-enabled', sourceCount >= nextCost && followerCount >= followerCost);
                        summonBtn.classList.toggle('button-disabled', sourceCount < nextCost || followerCount < followerCost);
                    }
                }
                restoreMonsterCardState();
            }

            function describeSpecialAbility(effect) {
                switch (effect.type) {
                    case 'allMonsterEfficiency':
                        return `Increase all monster efficiency by ${(effect.value * 100).toFixed(1)}%`;
                    case 'followerEfficiencyMultiplier':
                        return `Increase follower efficiency by ${(effect.value * 100).toFixed(1)}% per monster`;
                    case 'followerEfficiency':
                        return `Increase follower efficiency by ${(effect.value * 100).toFixed(1)}%`;
                    case 'sourceProduction':
                        return `Increase source production by ${(effect.value * 100).toFixed(1)}%`;
                    case 'upgradeEffect':
                        return `Increase all upgrade effects by ${(effect.value * 100).toFixed(1)}%`;
                    case 'followerProduction':
                        return `Increase follower production by ${effect.value.toFixed(1)} per second`;
                    case 'cosmicResonance':
                        return `Increase all production by ${(effect.value * 100).toFixed(1)}%`;
                    case 'upgradeCost':
                        return `Reduce upgrade costs by ${(effect.value * 100).toFixed(1)}% (up to ${(effect.maxDiscount * 100).toFixed(1)}%)`;
                    case 'adventurerResistanceRecoveryTime':
                        return `Reduce adventurer resistance cooldown by ${(effect.value / 1000).toFixed(1)} second(s)`;
                    case 'miasmaEfficiency':
                        return `Increase miasma efficiency by ${(effect.value * 100).toFixed(1)}%`;
                    default:
                        return 'Unknown effect';
                }
            }

            function formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = Math.floor(seconds % 60);

                let timeString = '';
                if (hours > 0) timeString += `${hours}h `;
                if (minutes > 0 || hours > 0) timeString += `${minutes}m `;
                timeString += `${remainingSeconds}s`;

                return timeString.trim();
            }

            function formatNumber(num, decimalPlaces = 0) {
                if (!isFinite(num)) {
                    return "∞";
                }
                if (typeof num !== 'number' || isNaN(num)) {
                    console.warn(`Invalid number passed to formatNumber: ${num}`);
                    return '0';
                }

                if (num === 0) return '0';

                const absNum = Math.abs(num);
                if (absNum < 1e3) {
                    return num.toFixed(decimalPlaces);
                }

                const abbreviations = ['', 'K', 'M', 'B', 'T'];
                const maxAbbreviationIndex = abbreviations.length - 1;

                let tier = Math.floor(Math.log10(absNum) / 3);
                if (tier > maxAbbreviationIndex) {
                    // Use scientific notation for very large numbers
                    const exponent = Math.floor(Math.log10(absNum));
                    const mantissa = absNum / Math.pow(10, exponent);
                    return `${mantissa.toFixed(2)}e${exponent}`;
                } else {
                    const scaled = num / Math.pow(10, tier * 3);
                    const formatted = scaled.toFixed(decimalPlaces);
                    return `${formatted}${abbreviations[tier]}`;
                }
            }

            function safeFormatNumber(value, decimalPlaces = 0) {
                if (typeof value !== 'number' || !isFinite(value)) {
                    console.warn(`Invalid value encountered: ${value}`);
                    return '0';
                }
                return formatNumber(value, decimalPlaces);
            }

            function formatBigNumber(num) {
                if (typeof num === 'bigint') {
                    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                }
                return formatNumber(num);
            }

            function sanitizeGameState() {
                for (let key in gameState) {
                    if (typeof gameState[key] === 'number' && !isFinite(gameState[key])) {
                        console.warn(`Invalid game state value detected for ${key}: ${gameState[key]}`);
                        gameState[key] = 0;  // または適切なデフォルト値に設定
                    }
                }
            }

            function updateFollowerSection() {
                const followerSection = document.getElementById('followerSection');
                if (!followerSection) {
                    console.error("Follower section not found");
                    return;
                }

                const { followerProduction } = calculateResourceProduction();
                const nextFollowerCost = getCost('follower');

                followerSection.innerHTML = `
        <h2>Followers</h2>
        <div class="ascii-art" id="followerAsciiArt">
            ${asciiArt['Follower']}
        </div>
        <p>Count: <span id="followerCount">${formatNumber(Math.floor(gameState.followers), 0)}</span></p>
        <p>Efficiency: <span id="followerEfficiency">${formatNumber(gameState.followerEfficiency, 2)}</span></p>
        <p>Production: <span id="followerPerSecond">${formatNumber(followerProduction, 1)}</span>/sec</p>
        <p>Next Recruit Cost: <span id="nextFollowerCost">${formatNumber(nextFollowerCost, 0)}</span></p>
    `;

                // フォロワー召喚ボタンの更新
                const recruitFollowerBtn = document.getElementById('recruitFollowerBtn');
                if (recruitFollowerBtn) {
                    recruitFollowerBtn.textContent = `Recruit Follower`;
                    recruitFollowerBtn.disabled = gameState.source < nextFollowerCost;
                    recruitFollowerBtn.classList.toggle('button-enabled', gameState.source >= nextFollowerCost);
                    recruitFollowerBtn.classList.toggle('button-disabled', gameState.source < nextFollowerCost);
                }
            }

            // logAction 関数の再定義
            function logAction(message) {
                const log = document.getElementById('log');
                if (log) {
                    const p = document.createElement('p');
                    // 数値を含むメッセージの場合、formatNumber関数を使用して整形
                    p.textContent = message.replace(/\d+(\.\d+)?/g, match => formatNumber(parseFloat(match)));
                    log.insertBefore(p, log.firstChild);
                    if (log.childElementCount > 20) {
                        log.removeChild(log.lastChild);
                    }
                }
                debug(`Log: ${message}`);
            }

            function saveGame() {
                const gameData = JSON.stringify({
                    version: gameVersion,
                    source: gameState.source,
                    miasma: gameState.miasma,
                    followers: gameState.followers,
                    upgradeCostMultiplier: gameState.upgradeCostMultiplier,
                    monsters: gameState.monsters,
                    upgrades: gameState.upgrades,
                    followerEfficiency: gameState.followerEfficiency,
                    cosmicAlignmentBonus: gameState.cosmicAlignmentBonus,
                    astralProjectionRate: gameState.astralProjectionRate,
                    quantumEntanglementBonus: gameState.quantumEntanglementBonus,
                    temporalManipulationBonus: gameState.temporalManipulationBonus,
                    eldritchEvolutionRate: gameState.eldritchEvolutionRate,
                    upgradeCostMultiplier: gameState.upgradeCostMultiplier,

                    adventurers: gameState.adventurers.map(adventurer => ({
                        ...adventurer,
                        cooldownEndTime: adventurer.cooldownEndTime || 0
                    }))
                });
                localStorage.setItem('cultistComplexSave', gameData);
                console.log("Game saved:", gameData);
                logAction("Game saved successfully");
            }

            function loadGame() {
                const savedGame = localStorage.getItem('cultistComplexSave');
                if (savedGame) {
                    try {
                        const loadedState = JSON.parse(savedGame);
                        console.log("Loaded state:", loadedState);

                        if (loadedState.version !== gameVersion) {
                            console.warn(`Save version (${loadedState.version}) differs from current game version (${gameVersion}). Some data might not be compatible.`);
                        }

                        gameState.source = validateNumber(loadedState.source, 0);
                        gameState.miasma = validateNumber(loadedState.miasma, 0);
                        gameState.followers = validateNumber(loadedState.followers, 0);
                        gameState.monsters = validateMonsters(loadedState.monsters);
                        gameState.upgrades = Array.isArray(loadedState.upgrades) ? loadedState.upgrades : [];
                        gameState.followerEfficiency = validateNumber(loadedState.followerEfficiency, 0.1);
                        gameState.upgradeCostMultiplier = loadedState.upgradeCostMultiplier || 1;
                        gameState.cosmicAlignmentBonus = validateNumber(loadedState.cosmicAlignmentBonus, 1);
                        gameState.astralProjectionRate = validateNumber(loadedState.astralProjectionRate, 0);
                        gameState.quantumEntanglementBonus = validateNumber(loadedState.quantumEntanglementBonus, 0);
                        gameState.temporalManipulationBonus = validateNumber(loadedState.temporalManipulationBonus, 1);
                        gameState.eldritchEvolutionRate = validateNumber(loadedState.eldritchEvolutionRate, 0);
                        gameState.upgradeCostMultiplier = validateNumber(loadedState.upgradeCostMultiplier, 1);
                        gameState.adventurers = loadedState.adventurers.map(adventurer => ({
                            ...adventurer,
                            cooldownEndTime: adventurer.cooldownEndTime || 0,

                        }));

                        console.log("Processed game state:", gameState);

                        updateUpgradeSymbols();
                        logAction("Game loaded successfully");
                    } catch (error) {
                        console.error("Error loading game:", error);
                        logAction("Error loading game. Starting new game.");
                        resetGameState();
                    }
                } else {
                    logAction("No saved game found");
                    resetGameState();
                }
                updateAdventurerStates();
                updateMadnessTable();
                updateEmblem();
            }


            function validateNumber(value, defaultValue) {
                return typeof value === 'number' && !isNaN(value) ? value : defaultValue;
            }

            function validateMonsters(monsters) {
                const validatedMonsters = {};
                for (let monsterName in monsters) {
                    if (monsters.hasOwnProperty(monsterName)) {
                        validatedMonsters[monsterName] = {
                            count: validateNumber(monsters[monsterName].count, 0),
                            sourceEfficiency: validateNumber(monsters[monsterName].sourceEfficiency, gameState.monsters[monsterName].sourceEfficiency),
                            miasmaEfficiency: validateNumber(monsters[monsterName].miasmaEfficiency, gameState.monsters[monsterName].miasmaEfficiency),
                            baseFollowerCost: validateNumber(monsters[monsterName].baseFollowerCost, gameState.monsters[monsterName].baseFollowerCost),
                            followerCostGrowth: validateNumber(monsters[monsterName].followerCostGrowth, gameState.monsters[monsterName].followerCostGrowth),
                            synergy: monsters[monsterName].synergy || gameState.monsters[monsterName].synergy,
                            specialAbility: validateSpecialAbility(monsters[monsterName].specialAbility, gameState.monsters[monsterName].specialAbility)
                        };
                    }
                }
                return validatedMonsters;
            }

            function validateSpecialAbility(loadedAbility, defaultAbility) {
                if (!loadedAbility) return defaultAbility;

                return {
                    trigger: validateNumber(loadedAbility.trigger, defaultAbility.trigger),
                    effect: {
                        type: loadedAbility.effect.type || defaultAbility.effect.type,
                        value: validateNumber(loadedAbility.effect.value, defaultAbility.effect.value),
                        maxDiscount: loadedAbility.effect.maxDiscount !== undefined ?
                            validateNumber(loadedAbility.effect.maxDiscount, defaultAbility.effect.maxDiscount) :
                            defaultAbility.effect.maxDiscount
                    }
                };
            }

            function resetGameAndClearSave() {
                debug("Resetting game and clearing save");
                const confirmReset = confirm("Are you sure you want to reset the game and clear all save data? This action cannot be undone.");

                if (confirmReset) {
                    // 統計情報のリセット
                    gameState.statistics = {
                        startTime: Date.now(),
                        totalSourceGenerated: 0,
                        totalMiasmaGenerated: 0,
                        totalFollowersRecruited: 0,
                        peakFollowers: 0,
                        totalMonstersSummoned: 0,
                        mostCommonMonster: '',
                        totalMadnessAttempts: 0,
                        successfulMadness: 0,
                        lastUpdate: Date.now()
                    };

                    // ローカルストレージから統計情報も削除
                    localStorage.removeItem('cultistComplexStats');
                    localStorage.removeItem('cultistComplexSave');

                    resetGameState();
                    rebuildUI();

                    // 統計情報の表示を更新
                    updateStatistics();

                    logAction("Game has been reset and all save data has been cleared.");
                    debug("Game reset and save cleared");
                } else {
                    debug("Game reset cancelled by user");
                }
            }

            function resetGameState() {
                debug("Resetting game state");
                // Deep copy initialGameState to gameState
                gameState = JSON.parse(JSON.stringify(initialGameState));
                debug("Game state reset complete");
            }

            function rebuildUI() {
                debug("Rebuilding UI");

                // リソース表示のリセット
                document.getElementById('largeSourceCount').textContent = '0';
                document.getElementById('largeSourcePerSecond').textContent = '0';
                document.getElementById('largeMiasmaCount').textContent = '0';
                document.getElementById('largeMiasmaPerSecond').textContent = '0';

                // フォロワーセクションの更新
                updateFollowerSection();

                // モンスターグリッドの再構築
                const monsterGrid = document.getElementById('monsterGrid');
                monsterGrid.innerHTML = '';
                updateMonsterGrid();

                // アップグレードグリッドの再構築
                const upgradeGrid = document.getElementById('upgradeGrid');
                upgradeGrid.innerHTML = '';
                updateUpgradeGrid();

                // ゲーム詳細の更新
                updateGameDetails();

                // 狂気テーブルの更新
                updateMadnessTable();

                // アップグレードシンボルのリセット
                updateUpgradeSymbols();

                // ログのクリア
                const logEntries = document.getElementById('logEntries');
                if (logEntries) {
                    logEntries.innerHTML = '';
                }

                // エンブレムの更新
                updateEmblem();

                debug("UI rebuild complete");
            }

            function resetDOM() {
                debug("Resetting DOM elements");
                // モンスターグリッドをクリア
                const monsterGrid = document.getElementById('monsterGrid');
                if (monsterGrid) monsterGrid.innerHTML = '';

                // アップグレードグリッドをクリア
                const upgradeGrid = document.getElementById('upgradeGrid');
                if (upgradeGrid) upgradeGrid.innerHTML = '';

                // ゲーム詳細をクリア
                const gameDetails = document.getElementById('gameDetails');
                if (gameDetails) gameDetails.innerHTML = '';

                // ログをクリア
                const log = document.getElementById('log');
                if (log) log.innerHTML = '';

                // ソースカウントとソース/秒をリセット
                document.getElementById('largeSourceCount').textContent = '0';
                document.getElementById('largeSourcePerSecond').textContent = '0.0';

                // ミアズマカウントとミアズマ/秒をリセット
                document.getElementById('largeMiasmaCount').textContent = '0';
                document.getElementById('largeMiasmaPerSecond').textContent = '0.0';

                // アップグレードシンボルをクリア
                const upgradeSymbols = document.getElementById('upgradeSymbols');
                if (upgradeSymbols) upgradeSymbols.innerHTML = '';

                // フォロワーセクションをリセット
                const followerSection = document.getElementById('followerSection');
                if (followerSection) {
                    followerSection.querySelector('#followerCount').textContent = '0';
                    followerSection.querySelector('#followerEfficiency').textContent = '0.1';
                }

                debug("DOM reset complete");
            }

            function setupEventListeners() {
                debug("Setting up event listeners");

                const recruitFollowerBtn = document.getElementById('recruitFollowerBtn');
                if (recruitFollowerBtn) {
                    recruitFollowerBtn.addEventListener('click', recruitFollower);
                    debug("Recruit Follower button listener added");
                } else {
                    debug("Recruit Follower button not found");
                }

                const monsterGrid = document.getElementById('monsterGrid');
                if (monsterGrid) {
                    monsterGrid.addEventListener('click', function (event) {
                        if (event.target.classList.contains('summon-monster-btn')) {
                            const monster = event.target.dataset.monster;
                            debug(`Summon button clicked for ${monster}`);
                            executeAction(summonMonster, { type: monster });
                        }
                    });
                    debug("Monster Grid listener added");
                } else {
                    debug("Monster Grid not found");
                }

                const upgradeGrid = document.getElementById('upgradeGrid');
                if (upgradeGrid) {
                    upgradeGrid.addEventListener('click', function (event) {
                        if (event.target.classList.contains('buy-upgrade-btn')) {
                            buyUpgrade(event.target.dataset.upgrade);
                        }
                    });
                    debug("Upgrade Grid listener added");
                } else {
                    debug("Upgrade Grid not found");
                }

                const adventurersContainer = document.getElementById('adventurers');
                if (adventurersContainer) {
                    adventurersContainer.addEventListener('click', function (event) {
                        if (event.target.classList.contains('madness-btn') && !event.target.disabled) {
                            const index = parseInt(event.target.dataset.index);
                            attemptMadness(index);
                        }
                    });
                    debug("Adventurers container listener added");
                } else {
                    debug("Adventurers container not found");
                }

                const toggleMadnessTableBtn = document.getElementById('toggleMadnessTable');
                if (toggleMadnessTableBtn) {
                    toggleMadnessTableBtn.addEventListener('click', toggleMadnessTable);
                    debug("Jump to Madness Table button listener added");  // コメントを更新
                } else {
                    debug("Jump to Madness Table button not found");  // コメントを更新
                }

                const backToTopBtn = document.getElementById("backToTopBtn");
                if (backToTopBtn) {
                    backToTopBtn.addEventListener("click", backToTop);
                    debug("Back to Top button listener added");
                } else {
                    debug("Back to Top button not found");
                }

                // セーブ・ロードボタンのイベントリスナー
                const saveLoadButtons = document.getElementById('saveLoadButtons');
                if (saveLoadButtons) {
                    const saveButton = saveLoadButtons.querySelector('button:nth-child(1)');
                    const loadButton = saveLoadButtons.querySelector('button:nth-child(2)');

                    if (saveButton) {
                        saveButton.addEventListener('click', saveGame);
                        debug("Save button listener added");
                    } else {
                        debug("Save button not found");
                    }

                    if (loadButton) {
                        loadButton.addEventListener('click', loadGame);
                        debug("Load button listener added");
                    } else {
                        debug("Load button not found");
                    }
                } else {
                    debug("Save/Load buttons container not found");
                }
            }

            function gameLoop() {
                const { sourceProduction, miasmaProduction, followerProduction } = calculateResourceProduction();
                const timeFactor = 0.1 * timeAcceleration;
                gameState.source += sourceProduction * timeFactor;
                gameState.miasma += miasmaProduction * timeFactor;

                // フォロワーの生産を累積
                gameState.followerAccumulator = (gameState.followerAccumulator || 0) + followerProduction * timeFactor;

                // 累積が1以上になった場合、整数部分をフォロワー数に加算
                if (gameState.followerAccumulator >= 1) {
                    const newFollowers = Math.floor(gameState.followerAccumulator);
                    gameState.followers += newFollowers;
                    gameState.followerAccumulator -= newFollowers;
                }

                updateAdventurerStates();
                applySpecialAbilities();
                sanitizeGameState();

                updateDisplay();
                updateMadnessTable();
                updateEmblem();
            }

            function startGameLoop() {
                debug("Starting game loop");
                // gameLoopを0.1秒ごとに実行
                updateEmblem();
                debug("Game loop started");
            }

            function initializeGame() {
                debug("Initializing game");
                document.getElementById('version-display').textContent = `v${gameVersion}`;
                setupTopButtons();
                setupEventListeners();
                setEmblem();

                // Load saved game or reset to initial state
                const savedGame = localStorage.getItem('cultistComplexSave');
                if (savedGame) {
                    loadGame();
                } else {
                    resetGameState();
                }

                updateEmblem();
                startGameLoop();
                debug("Game initialization complete");
            }

            // DOMContentLoaded イベントリスナーの修正
            document.addEventListener('DOMContentLoaded', function () {
                debug("DOM fully loaded");
                initializeGame();
                debug("Game startup complete");
            });

            // ページを離れる前にセーブする処理の追加
            window.addEventListener('beforeunload', function () {
                debug("Saving game before unload");
                saveGame();
            });
            // Start game loop (runs every 0.1 seconds)
            setInterval(gameLoop, 100);

            // ページを離れる前にセーブ
            window.addEventListener('beforeunload', saveGame);

            // Initialize statistics in gameState if not present
            if (!gameState.statistics) {
                gameState.statistics = {
                    startTime: Date.now(),
                    totalSourceGenerated: 0,
                    totalMiasmaGenerated: 0,
                    totalFollowersRecruited: 0,
                    peakFollowers: 0,
                    totalMonstersSummoned: 0,
                    mostCommonMonster: '',
                    totalMadnessAttempts: 0,
                    successfulMadness: 0,
                    lastUpdate: Date.now()
                };
            }

            // Add statistics button
            document.addEventListener('DOMContentLoaded', function () {
                const topButtons = document.getElementById('top-buttons');
                const existingStatsButton = document.getElementById('statisticsButton');
                if (!existingStatsButton) {
                    const statsButton = document.createElement('button');
                    statsButton.id = 'statisticsButton';
                    statsButton.textContent = 'Statistics';
                    statsButton.onclick = toggleStatisticsModal;
                    topButtons.insertBefore(statsButton, topButtons.firstChild);
                }

                // Initialize modal
                const modal = document.getElementById('statisticsModal');
                if (modal) {
                    modal.style.display = 'none';
                    modal.classList.remove('active');
                }
            });

            // Modify existing game functions to track statistics
            const originalGameLoop = gameLoop;
            gameLoop = function () {
                const before = {
                    source: gameState.source,
                    miasma: gameState.miasma
                };

                originalGameLoop();

                if (gameState.statistics) {
                    gameState.statistics.totalSourceGenerated += Math.max(0, gameState.source - before.source);
                    gameState.statistics.totalMiasmaGenerated += Math.max(0, gameState.miasma - before.miasma);
                    gameState.statistics.peakFollowers = Math.max(gameState.statistics.peakFollowers, gameState.followers);
                }
            };

            const originalRecruitFollower = recruitFollower;
            recruitFollower = function () {
                const beforeCount = gameState.followers;
                originalRecruitFollower();
                if (gameState.followers > beforeCount && gameState.statistics) {
                    gameState.statistics.totalFollowersRecruited++;
                }
            };

            const originalSummonMonster = summonMonster;
            summonMonster = function (type) {
                const beforeCount = gameState.monsters[type].count;
                originalSummonMonster(type);
                if (gameState.monsters[type].count > beforeCount && gameState.statistics) {
                    gameState.statistics.totalMonstersSummoned++;
                }
            };

            const originalAttemptMadness = attemptMadness;
            attemptMadness = function (index) {
                if (!gameState.statistics) return originalAttemptMadness(index);

                const adventurer = gameState.adventurers[index];
                const wasMad = adventurer.isMad;
                gameState.statistics.totalMadnessAttempts++;

                originalAttemptMadness(index);

                if (!wasMad && adventurer.isMad) {
                    gameState.statistics.successfulMadness++;
                }
            };

            // Make sure all required functions are defined
            function updateStatistics() {
                if (!gameState.statistics) return;

                const stats = gameState.statistics;
                const timePlayed = Math.floor((Date.now() - stats.startTime) / 1000);

                document.getElementById('timePlayed').textContent = formatTime(timePlayed);
                document.getElementById('totalSourceGenerated').textContent = formatNumber(stats.totalSourceGenerated);
                document.getElementById('totalMiasmaGenerated').textContent = formatNumber(stats.totalMiasmaGenerated);
                document.getElementById('totalFollowersRecruited').textContent = formatNumber(stats.totalFollowersRecruited);
                document.getElementById('peakFollowers').textContent = formatNumber(stats.peakFollowers);
                document.getElementById('currentFollowerEfficiency').textContent = formatNumber(gameState.followerEfficiency, 2);
                document.getElementById('totalMonstersSummoned').textContent = formatNumber(stats.totalMonstersSummoned);

                const uniqueMonsters = Object.values(gameState.monsters).filter(m => m.count > 0).length;
                document.getElementById('uniqueMonsterTypes').textContent = uniqueMonsters;
                document.getElementById('mostCommonMonster').textContent = getMostCommonMonster();

                document.getElementById('totalMadnessAttempts').textContent = formatNumber(stats.totalMadnessAttempts);
                document.getElementById('successfulMadness').textContent = formatNumber(stats.successfulMadness);

                const successRate = stats.totalMadnessAttempts > 0
                    ? (stats.successfulMadness / stats.totalMadnessAttempts * 100).toFixed(1)
                    : 0;
                document.getElementById('madnessSuccessRate').textContent = `${successRate}%`;
            }

            function getMostCommonMonster() {
                let maxCount = 0;
                let mostCommon = 'None';

                for (const [monster, data] of Object.entries(gameState.monsters)) {
                    if (data.count > maxCount) {
                        maxCount = data.count;
                        mostCommon = monster;
                    }
                }

                return maxCount > 0 ? `${mostCommon} (${formatNumber(maxCount)})` : 'None';
            }

            // Add to save/load functions
            const originalSaveGame = saveGame;
            saveGame = function () {
                originalSaveGame();
                if (gameState.statistics) {
                    localStorage.setItem('cultistComplexStats', JSON.stringify(gameState.statistics));
                }
            };

            const originalLoadGame = loadGame;
            loadGame = function () {
                originalLoadGame();
                const savedStats = localStorage.getItem('cultistComplexStats');
                if (savedStats) {
                    gameState.statistics = JSON.parse(savedStats);
                }
            };

        </script>
</body>

</html>